<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eurocop Analytics | Seguridad P칰blica</title>
    
    <!-- FUENTES: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- ICONOS: FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ESTILOS MAPA: MapLibre GL JS -->
    <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
    
    <!-- CONTROL DE VERSIONES -->
    <link rel="stylesheet" href="style.css?v=1.1">

    <!-- LIBRER칈AS PARA EXPORTACI칍N PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

    <!-- OVERLAY PARA M칍VIL -->
    <div id="mobile-overlay" class="mobile-overlay" onclick="toggleSidebarMobile()"></div>

    <!-- NAVBAR SUPERIOR -->
    <nav class="navbar">
        <div class="nav-left-group">
            <button class="mobile-menu-btn" onclick="toggleSidebarMobile()">
                <i class="fa-solid fa-bars"></i>
            </button>
            
            <div class="logo" onclick="goToMapping()" style="cursor:pointer" title="Volver a Configuraci칩n">
                <span class="logo-icon"><i class="fa-solid fa-shield-halved"></i></span>
                <span class="logo-text"><span data-i18n="nav_title">EUROCOP</span><span class="hide-mobile" data-i18n="nav_analytics"> ANALYTICS</span><span class="dot">.</span></span>
            </div>
        </div>

        <div class="nav-right">
            <!-- SELECTOR DE IDIOMA -->
            <select id="lang-selector" class="lang-select" onchange="changeLanguage(this.value)">
                <option value="es">游쀯릖 ES</option>
                <option value="eu">游낎 EU</option>
                <option value="ca">游리 CA</option>
                <option value="gl">游댯 GL</option>
            </select>

            <!-- <div id="display-filename" class="filename-pill" data-i18n="no_file">SIN ARCHIVO</div> -->
            
            <span id="kpi-total-filas" class="badge-records">0 <span data-i18n="kpi_reg">REG</span></span>
            
            <div class="nav-filters-info">
                <span class="hide-mobile"><strong data-i18n="lbl_year">A칌O:</strong> <span id="header-year" class="info-text">----</span> <span class="sep">|</span></span>
                <span class="hide-mobile"><strong data-i18n="lbl_month">MES:</strong> <span id="header-month" class="info-text">----</span> <span class="sep">|</span></span>
                <span class="hide-mobile"><strong data-i18n="lbl_cat">CAT:</strong> <span id="header-category" class="info-text">----</span></span>
            </div>
        </div>
    </nav>

    <!-- VISTA 1: CARGA DE ARCHIVOS -->
    <section id="upload-view" class="view-container active">
        <div class="upload-center">
            <div class="upload-card">
                <div class="brand-circle">
                    <i class="fa-solid fa-file-import"></i>
                </div>
                <h1 data-i18n="upload_title">Carga de Datos</h1>
                <p data-i18n="upload_desc">Sube tu archivo Excel (.xlsx) o CSV.</p>
                
                <div class="drop-zone" id="drop-zone">
                    <i class="fa-solid fa-cloud-arrow-up upload-icon"></i>
                    <span data-i18n="upload_drop">ARRASTRAR O TOCAR PARA SUBIR</span>
                    <input type="file" id="file-input" accept=".csv, .xlsx, .xls" hidden>
                </div>
                
                <div class="csv-info">
                    <small><i class="fa-solid fa-circle-info"></i> <span data-i18n="upload_mobile">Compatible con m칩viles</span></small>
                </div>

                <!-- BOTONES PDF -->
                <div class="manual-container">
                    <button onclick="openPdfModal('Manual.pdf', 'Manual de Ayuda')" class="btn-manual-pill">
                        <i class="fa-solid fa-book-open"></i>
                        <span data-i18n="btn_manual">Ver Manual</span>
                    </button>

                    <button onclick="openPdfModal('Actualizaciones.pdf', 'Novedades y Actualizaciones')" class="btn-manual-pill">
                        <i class="fa-solid fa-rotate"></i>
                        <span data-i18n="btn_updates">Actualizaciones</span>
                    </button>
                </div>

                <!-- MARCA -->
                <div class="brand-footer">
                    <span class="brand-label" data-i18n="brand_powered">Powered by</span>
                    <img src="./ImagenCoorporativa/zzenkiu.png" alt="Zzenkiu" class="brand-logo">
                    <div class="version-badge">v1.1</div> 
                </div>
            </div>
        </div>
    </section>

    <!-- VISTA 2: CONFIGURACI칍N -->
    <section id="mapping-view" class="view-container">
        <div class="config-panel">
            <div class="panel-header">
                <h2 data-i18n="config_title"><i class="fa-solid fa-sliders"></i> CONFIGURACI칍N</h2>
                <p data-i18n="config_desc">Vincula las columnas de tu archivo.</p>
            </div>
            
            <div class="cards-grid mapping-layout">
                <div class="mapping-col">
                    <div class="card">
                        <label><strong data-i18n="col_id">CONTADOR / ID</strong></label>
                        <select id="map-expediente" class="styled-select"></select>
                    </div>
                    <div class="card">
                        <label><strong>LATITUD (Y) <small style="font-weight:400; color:#888;">(Opcional)</small></strong></label>
                        <select id="map-lat" class="styled-select"></select>
                    </div>
                    <div class="card">
                        <label><strong>LONGITUD (X) <small style="font-weight:400; color:#888;">(Opcional)</small></strong></label>
                        <select id="map-lon" class="styled-select"></select>
                    </div>
                </div>

                <div class="mapping-col">
                    <div class="card full-height">
                        <div style="margin-bottom: 25px;">
                            <label><strong data-i18n="col_date">FECHA (Obligatorio)</strong></label>
                            <select id="map-fecha" class="styled-select"></select>
                        </div>
                        <div>
                            <label><strong data-i18n="col_time">HORA (Opcional)</strong></label>
                            <select id="map-hora" class="styled-select"></select>
                        </div>
                    </div>
                </div>

                <div class="mapping-col">
                    <div class="card highlighted-card">
                        <div class="highlight-badge">AN츼LISIS</div>
                        <label><strong data-i18n="col_cat">CATEGOR칈A / TIPO</strong></label>
                        <p class="card-desc" data-i18n="col_cat_desc">Selecciona la columna que define el tipo de incidencia.</p>
                        <select id="map-categoria" class="styled-select select-accent"></select>
                    </div>

                    <div class="card">
                        <label><strong data-i18n="col_loc">LOCALIDAD (Opcional)</strong></label>
                        <p class="card-desc" data-i18n="col_loc_desc">Escribe el nombre para forzar la zona. D칠jalo vac칤o para GPS.</p>
                        <input type="text" id="map-localidad" class="styled-select" placeholder="Ej: DURANGO" autocomplete="off">
                    </div>
                </div>
            </div>
            
            <div class="action-footer">
                <button onclick="location.reload()" class="btn-mini" data-i18n="btn_cancel">Cancelar</button>
                <button id="btn-visualizar" class="btn-primary" data-i18n="btn_generate">GENERAR DASHBOARD</button>
            </div>
        </div>
    </section>

    <!-- VISTA 3: DASHBOARD -->
    <section id="dashboard-view" class="view-container">
        
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header-mobile">
                <h3 data-i18n="sidebar_filters">Filtros</h3>
                <button class="btn-close-sidebar" onclick="toggleSidebarMobile()"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="sidebar-actions">
                <button class="btn-export-pdf" onclick="FncConvertirPdf.exportar()">
                    <i class="fa-solid fa-file-pdf"></i> <span data-i18n="btn_export">EXPORTAR A PDF</span>
                </button>
            </div>

            <div class="filter-header"><i class="fa-solid fa-filter"></i> <span data-i18n="filter_header">FILTROS AVANZADOS</span></div>
            
            <div class="filter-group">
                <label data-i18n="filter_years">A침os</label>
                <div class="custom-dropdown" id="drop-year">
                    <div class="dropdown-header" onclick="toggleDropdown('list-year')">
                        <span id="label-year" data-i18n="sel_select">Seleccionar...</span>
                        <i class="fa-solid fa-chevron-down"></i>
                    </div>
                    <div id="list-year" class="dropdown-content">
                        <div class="dropdown-controls">
                            <button class="btn-mini" onclick="toggleGroup('items-year', true, event)" data-i18n="sel_all">Todos</button>
                            <button class="btn-mini" onclick="toggleGroup('items-year', false, event)" data-i18n="sel_none">Ninguno</button>
                        </div>
                        <div class="dropdown-items" id="items-year"></div>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label data-i18n="filter_months">Meses</label>
                <div class="custom-dropdown" id="drop-month">
                    <div class="dropdown-header" onclick="toggleDropdown('list-month')">
                        <span id="label-month" data-i18n="sel_select">Seleccionar...</span>
                        <i class="fa-solid fa-chevron-down"></i>
                    </div>
                    <div id="list-month" class="dropdown-content">
                        <div class="dropdown-controls">
                            <button class="btn-mini" onclick="toggleGroup('items-month', true, event)" data-i18n="sel_all">Todos</button>
                            <button class="btn-mini" onclick="toggleGroup('items-month', false, event)" data-i18n="sel_none">Ninguno</button>
                        </div>
                        <div class="dropdown-items" id="items-month"></div>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label data-i18n="filter_cats">Categor칤as</label>
                <div class="custom-dropdown" id="drop-category">
                    <div class="dropdown-header" onclick="toggleDropdown('list-category')">
                        <span id="label-category" data-i18n="sel_select">Seleccionar...</span>
                        <i class="fa-solid fa-chevron-down"></i>
                    </div>
                    <div id="list-category" class="dropdown-content">
                        <div class="dropdown-controls">
                            <button class="btn-mini" onclick="toggleGroup('items-category', true, event)" data-i18n="sel_all">Todos</button>
                            <button class="btn-mini" onclick="toggleGroup('items-category', false, event)" data-i18n="sel_none">Ninguno</button>
                        </div>
                        <div class="dropdown-items" id="items-category"></div>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <img src="./ImagenCoorporativa/zzenkiu.png" alt="Zzenkiu" class="sidebar-logo">
            </div>
        </aside>

        <main class="main-content">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon"><i class="fa-solid fa-folder-open"></i></div>
                    <div class="kpi-data"><h3 data-i18n="kpi_expedientes">Expedientes</h3><span id="kpi-count">0</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #2dce89;"><i class="fa-solid fa-location-crosshairs"></i></div>
                     <div class="kpi-data"><h3 data-i18n="kpi_zona">Zona</h3><span id="kpi-location" data-i18n="kpi_waiting">Esperando...</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #fb6340;"><i class="fa-solid fa-calendar-check"></i></div>
                    <div class="kpi-data">
                        <!-- 1. ID para el t칤tulo -->
                        <h3 id="card-label-titulo">TITULO</h3> 
                        <!-- 2. ID para el nombre del archivo -->
                        <span id="card-text-filename">SIN ARCHIVO</span>
                    </div>
                </div>
            </div>

            <div class="charts-grid-top">
                <div class="chart-container" id="container-timeline">
                    <div class="chart-header">
                        <h4 data-i18n="chart_timeline">Evoluci칩n Temporal</h4>
                        <div class="header-actions">
                            <select id="select-temporal-view" class="btn-mini" onchange="changeTemporalView(this.value)">
                                <option value="year" data-i18n="view_years">Vista: A침os</option>
                                <option value="month" selected data-i18n="view_months">Vista: Meses</option>
                                <option value="quarter" data-i18n="view_quarters">Vista: Trimestral</option>
                                <option value="day" data-i18n="view_days">Vista: D칤as Semanal</option>
                            </select>
                            
                            <button class="btn-mini" id="btn-toggle-view" onclick="toggleTimelineView()" title="Ver Tabla de Datos">
                                <i class="fa-solid fa-table"></i>
                            </button>

                            <button class="btn-maximize" onclick="toggleFullscreen('container-timeline')">
                                <i class="fa-solid fa-maximize"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="canvas-wrapper">
                        <canvas id="chart-timeline"></canvas>
                        <div id="table-timeline-view" class="table-view" style="display: none;"></div>
                    </div>
                </div>

                <div class="chart-container" id="container-category">
                    <div class="chart-header">
                        <h4 data-i18n="chart_top">Top Tipos</h4>
                        <div class="header-actions">
                            <button class="btn-mini" id="btn-toggle-view-cat" onclick="toggleCategoryView()" title="Ver Tabla de Datos">
                                <i class="fa-solid fa-table"></i>
                            </button>
                            <button class="btn-maximize" onclick="toggleFullscreen('container-category')">
                                <i class="fa-solid fa-maximize"></i>
                            </button>
                        </div>
                    </div>
                    <div class="canvas-wrapper">
                        <canvas id="chart-category"></canvas>
                        <div id="table-category-view" class="table-view" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <div class="bottom-grid">
                <div class="chart-container" id="container-hours">
                    <div class="chart-header">
                        <h4 data-i18n="chart_hours">Horas</h4>
                        <div class="header-actions">
                            <!-- Bot칩n Tabla Horas -->
                            <button class="btn-mini" id="btn-toggle-view-hours" onclick="toggleHoursView()" title="Ver Tabla de Datos">
                                <i class="fa-solid fa-table"></i>
                            </button>
                            <button class="btn-maximize" onclick="toggleFullscreen('container-hours')">
                                <i class="fa-solid fa-maximize"></i>
                            </button>
                        </div>
                    </div>
                    <div class="canvas-wrapper">
                        <canvas id="chart-hours"></canvas>
                        <!-- Tabla Horas -->
                        <div id="table-hours-view" class="table-view" style="display: none;"></div>
                    </div>
                </div>
                
                <div class="map-container-wrapper" id="container-map">
                    <div class="chart-header">
                        <h4 data-i18n="chart_map">Mapa</h4>
                        <div class="header-actions">
                            <button class="btn-mini" id="btn-heatmap" onclick="toggleHeatmap(this)">
                                <i class="fa-solid fa-fire"></i>
                            </button>
                            <button class="btn-mini" onclick="toggleSatelite(this)">
                                <i class="fa-solid fa-earth-americas"></i>
                            </button>
                            <button class="btn-mini" onclick="toggle3D()">
                                <i class="fa-solid fa-cube"></i>
                            </button>
                            <button class="btn-maximize" onclick="toggleFullscreen('container-map')">
                                <i class="fa-solid fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="canvas-wrapper">
                        <div id="main-map"></div>
                    </div>
                </div>
            </div>
        </main>
    </section>

    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner-box">
            <div class="spinner"></div>
            <!-- A칌ADIDO data-i18n -->
            <p data-i18n="loading_msg">Procesando archivo...</p>
        </div>
    </div>
    <!-- MODAL DE REGISTROS DESCARTADOS (SIN FECHA) -->
    <!-- MODAL DE REGISTROS DESCARTADOS (SIN FECHA) - VERSI칍N MEJORADA VISIBILIDAD -->
    <div id="rejected-modal" class="pdf-modal-overlay">
        <div class="pdf-modal-content" style="max-width: 600px; height: auto; max-height: 80vh; background-color: #34495e;"> 
            <!-- Header Rojo -->
            <div class="pdf-header" style="background: #f5365c; color: white;"> 
                <h3><i class="fa-solid fa-triangle-exclamation"></i> Expedientes no integrados</h3>
                <button onclick="closeRejectedModal()" class="btn-close-pdf" style="color: white;"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="pdf-body" style="padding: 25px;">
                <!-- TEXTO DE AVISO (Color Blanco y un poco m치s grande) -->
                <p style="margin-bottom: 20px; color: #ffffff; font-size: 15px; line-height: 1.4;">
                    Los siguientes expedientes <strong style="color: #ff8fa3;">no tienen fecha v치lida</strong> y no se han incluido en el recuento:
                </p>
                
                <!-- LISTA (Letra m치s grande y negrita) -->
                <div id="rejected-list" style="
                    background: #ffffff; 
                    border: 2px solid #f5365c; /* Borde rojo para destacar */
                    border-radius: 8px; 
                    padding: 15px; 
                    max-height: 350px; 
                    overflow-y: auto; 
                    font-family: 'Courier New', monospace; 
                    font-size: 16px;    /* AUMENTADO: Antes 13px */
                    line-height: 1.6;   /* AUMENTADO: Espacio entre l칤neas */
                    color: #333;        /* Texto negro sobre fondo blanco */
                    font-weight: bold;  /* Negrita */
                    box-shadow: inset 0 0 10px rgba(0,0,0,0.1);">
                    <!-- Aqu칤 se inyectar치 la lista -->
                </div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button onclick="closeRejectedModal()" class="btn-primary" style="background:#5e72e4; border:none; padding: 12px 25px; font-size: 14px;">ENTENDIDO</button>
                </div>
            </div>
        </div>
    </div>
    <div id="pdf-modal" class="pdf-modal-overlay">
        <div class="pdf-modal-content">
            <div class="pdf-header">
                <h3 id="pdf-modal-title"><i class="fa-solid fa-book"></i> Documento</h3>
                <button onclick="closePdfModal()" class="btn-close-pdf"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="pdf-body">
                <iframe src="" id="pdf-frame" frameborder="0"></iframe>
            </div>
        </div>
    </div>

    <!-- LIBRER칈AS EXTERNAS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
    
    <!-- L칍GICA script CONTROL VERSIONES-->
    <script src="languages.js"></script>
    <script src="script.js?v=1.1"></script>
    <script src="FncConvertirPdf.js"></script>

</body>
</html>