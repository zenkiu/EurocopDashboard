<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eurocop Analytics | Seguridad P√∫blica</title>
    <link rel="icon" href="./ImagenCoorporativa/zzenkiu.png" type="image/png">
    <!-- FUENTES: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- ICONOS: FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ESTILOS MAPA: MapLibre GL JS -->
    <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
    
    <!-- CONTROL DE VERSIONES Y CARGA CSS -->
    <script src="version.js"></script>
    <script>
        document.write('<link rel="stylesheet" href="style.css?v=' + EUROCOP_VERSION + '">');
    </script>

    <!-- LIBRER√çAS PARA EXPORTACI√ìN PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- LIBRER√çA GEOM√âTRICA (Turf.js) -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
</head>
<body>

    <!-- OVERLAY PARA M√ìVIL -->
    <div id="mobile-overlay" class="mobile-overlay" onclick="toggleSidebarMobile()"></div>

    <!-- NAVBAR SUPERIOR -->
    <nav class="navbar">
        <div class="nav-left-group">
            <button class="mobile-menu-btn" onclick="toggleSidebarMobile()">
                <i class="fa-solid fa-bars"></i>
            </button>
            
            <!-- El div principal ya no tiene onclick -->
            <div class="logo">
                <!-- El icono queda libre (no es clickable) -->
                <span class="logo-icon"><i class="fa-solid fa-shield-halved"></i></span>
                
                <!-- Solo el texto tiene el evento y el puntero -->
                <span class="logo-text" onclick="goToMapping()" style="cursor:pointer" title="Volver a Configuraci√≥n">
                    <span data-i18n="nav_title">EUROCOP</span>
                    <span class="hide-mobile" data-i18n="nav_analytics"> ANALYTICS</span>
                    <span class="dot">.</span>
                </span>
            </div>
        </div>

        <div class="nav-right">
            <!-- SELECTOR DE IDIOMA -->
            <select id="lang-selector" class="lang-select" onchange="changeLanguage(this.value)">
                <option value="es">üî¥ ES</option>
                <option value="eu">üü¢ EU</option>
                <option value="ca">üü° CA</option>
                <option value="gl">üîµ GL</option>
            </select>

            <!-- <div id="display-filename" class="filename-pill" data-i18n="no_file">SIN ARCHIVO</div> -->
            
            <span id="kpi-total-filas" class="badge-records">0 <span data-i18n="kpi_reg">REG</span></span>
            
            <div class="nav-filters-info">
                <span class="hide-mobile"><strong data-i18n="lbl_year">A√ëO:</strong> <span id="header-year" class="info-text">----</span> <span class="sep">|</span></span>
                <span class="hide-mobile"><strong data-i18n="lbl_month">MES:</strong> <span id="header-month" class="info-text">----</span> <span class="sep">|</span></span>
                <span class="hide-mobile"><strong data-i18n="lbl_cat">CAT:</strong> <span id="header-category" class="info-text">----</span></span>
            </div>
        </div>
    </nav>

    <!-- VISTA 1: CARGA DE ARCHIVOS -->
    <section id="upload-view" class="view-container active">
        <div class="upload-center">
            <div class="upload-card">
                <div class="brand-circle">
                    <i class="fa-solid fa-file-import"></i>
                </div>
                <h1 data-i18n="upload_title">Carga de Datos</h1>
                <p data-i18n="upload_desc">Sube tu archivo Excel (.xlsx) o CSV.</p>
                
                <div class="drop-zone" id="drop-zone">
                    <i class="fa-solid fa-cloud-arrow-up upload-icon"></i>
                    <span data-i18n="upload_drop">ARRASTRAR O TOCAR PARA SUBIR</span>
                    <input type="file" id="file-input" accept=".csv, .xlsx, .xls" hidden>
                </div>
                
                <div class="csv-info">
                    
                    <small class="clickable-info" onclick="openImageModal('./ImagenCoorporativa/Infografia.png', 'Infograf√≠a')">
                        <i class="fa-solid fa-circle-info"></i> 
                        <span data-i18n="upload_mobile">Compatible con m√≥viles</span>
                    </small>
                </div>

                <!-- BOTONES PDF -->
                <!-- BOTONES PDF -->
                <div class="manual-container">
                    <button onclick="openPdfModal('Manual.pdf', 'Manual de Ayuda')" class="btn-manual-pill">
                        <i class="fa-solid fa-book-open"></i>
                        <span data-i18n="btn_manual">Ver Manual</span>
                    </button>

                    <button onclick="openPdfModal('Actualizaciones.pdf', 'Novedades y Actualizaciones')" class="btn-manual-pill">
                        <i class="fa-solid fa-rotate"></i>
                        <span data-i18n="btn_updates">Actualizaciones</span>
                    </button>

                    <!-- NUEVO BOT√ìN: DESCARGA DE MEMORIAS -->
                    <a href="./EurocopMemorias/EurocopMemorias.zip" download class="btn-manual-pill" style="text-decoration: none;">
                        <i class="fa-solid fa-file-zipper"></i>
                        <span data-i18n="btn_memorias">Memorias</span>
                    </a>
                </div>

            <!-- MARCA -->
                <div class="brand-footer">
                    <span class="brand-label" data-i18n="brand_powered">Powered by</span>
                    <img src="./ImagenCoorporativa/zzenkiu.png" alt="Zzenkiu" class="brand-logo">
                    <!-- ETIQUETA VAC√çA (Se llena con JS) -->
                    <div id="app-version-badge" class="version-badge"></div> 
                </div>
            </div>
        </div>
    </section>

    <!-- VISTA 2: CONFIGURACI√ìN -->
    <section id="mapping-view" class="view-container">
        <div class="config-panel">
            <div class="panel-header">
                <h2 data-i18n="config_title"><i class="fa-solid fa-sliders"></i> CONFIGURACI√ìN</h2>
                <p data-i18n="config_desc">Vincula las columnas de tu archivo.</p>
            </div>

            <!-- Bot√≥n para mostrar/ocultar campos configurados -->
            <div style="margin-bottom: 15px; text-align: center;">
                <button id="toggle-configured-fields" onclick="toggleConfiguredFields()" class="btn-toggle-fields" style="
                    background: #f7fafc; 
                    border: 1px solid #e2e8f0; 
                    padding: 10px 20px; 
                    border-radius: 8px; 
                    cursor: pointer; 
                    font-size: 14px; 
                    font-weight: 600;
                    color: #4a5568;
                    transition: all 0.2s;">
                    <i class="fa-solid fa-eye"></i> <span id="toggle-text" data-i18n="btn_show_configured">Mostrar campos configurados</span>
                </button>
            </div>
            
            <div class="cards-grid mapping-layout" id="mapping-grid">
                <!-- SECCI√ìN CAMPOS CONFIGURADOS (OCULTOS POR DEFECTO) -->
                <div class="mapping-col configured-fields-section" style="display: none;">
                    <div class="card">
                        <label><strong data-i18n="col_id">CONTADOR / ID</strong></label>
                        <select id="map-expediente" class="styled-select configured-field"></select>
                    </div>
                    <div class="card">
                        <label><strong>LATITUD (Y) <small style="font-weight:400; color:#888;">(Opcional)</small></strong></label>
                        <select id="map-lat" class="styled-select configured-field"></select>
                    </div>
                    <div class="card">
                        <label><strong>LONGITUD (X) <small style="font-weight:400; color:#888;">(Opcional)</small></strong></label>
                        <select id="map-lon" class="styled-select configured-field"></select>
                    </div>
                </div>

                <div class="mapping-col configured-fields-section" style="display: none;">
                    <div class="card">
                        <label><strong data-i18n="col_date">FECHA (Obligatorio)</strong></label>
                        <select id="map-fecha" class="styled-select configured-field"></select>
                    </div>
                    <div class="card">
                        <label><strong data-i18n="col_time">HORA (Opcional)</strong></label>
                        <select id="map-hora" class="styled-select configured-field"></select>
                    </div>
                    <!-- En la columna 2 de mapping-view -->
                    <div class="card">
                        <label><strong data-i18n="col_street">CALLE / DIRECCI√ìN (Opcional)</strong></label>
                        <select id="map-calle" class="styled-select configured-field"></select>
                    </div>
                </div>

                <!-- COLUMNA AN√ÅLISIS - SIEMPRE VISIBLE Y CENTRADA -->
                <div class="mapping-col visible-fields-section">
                    <div class="card highlighted-card">
                        <div class="highlight-badge">AN√ÅLISIS</div>
                        <label><strong data-i18n="col_cat">CATEGOR√çA / TIPO</strong></label>
                        <select id="map-categoria" class="styled-select select-accent"></select>
                    </div>

                    <div class="card">
                        <label><strong data-i18n="col_loc">LOCALIDAD (Opcional)</strong></label>
                        <input type="text" id="map-localidad" class="styled-select" placeholder="Ej: DURANGO" autocomplete="off">
                    </div>
                </div>
            </div>
            
            <div class="action-footer">
                <button onclick="location.reload()" class="btn-mini" data-i18n="btn_cancel">Cancelar</button>
                <button id="btn-visualizar" class="btn-primary" data-i18n="btn_generate">GENERAR DASHBOARD</button>
            </div>
        </div>
    </section>

    <!-- VISTA 3: DASHBOARD -->
    <section id="dashboard-view" class="view-container">
        
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header-mobile">
                <h3 data-i18n="sidebar_filters">Filtros</h3>
                <button class="btn-close-sidebar" onclick="toggleSidebarMobile()"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="sidebar-actions">
                <button class="btn-export-pdf" onclick="FncConvertirPdf.exportar()">
                    <i class="fa-solid fa-file-pdf"></i> <span data-i18n="btn_export">EXPORTAR A PDF</span>
                </button>
            </div>

            <div class="filter-header"><i class="fa-solid fa-filter"></i> <span data-i18n="filter_header">FILTROS AVANZADOS</span></div>
            
            <div class="filter-group">
                <label data-i18n="filter_years">A√±os</label>
                <div class="custom-dropdown" id="drop-year">
                    <div class="dropdown-header" onclick="toggleDropdown('list-year')">
                        <span id="label-year" data-i18n="sel_select">Seleccionar...</span>
                        <i class="fa-solid fa-chevron-down"></i>
                    </div>
                    <div id="list-year" class="dropdown-content">
                        <div class="dropdown-controls">
                            <button class="btn-mini" onclick="toggleGroup('items-year', true, event)" data-i18n="sel_all">Todos</button>
                            <button class="btn-mini" onclick="toggleGroup('items-year', false, event)" data-i18n="sel_none">Ninguno</button>
                        </div>
                        <div class="dropdown-items" id="items-year"></div>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label data-i18n="filter_months">Meses</label>
                <div class="custom-dropdown" id="drop-month">
                    <div class="dropdown-header" onclick="toggleDropdown('list-month')">
                        <span id="label-month" data-i18n="sel_select">Seleccionar...</span>
                        <i class="fa-solid fa-chevron-down"></i>
                    </div>
                    <div id="list-month" class="dropdown-content">
                        <div class="dropdown-controls">
                            <button class="btn-mini" onclick="toggleGroup('items-month', true, event)" data-i18n="sel_all">Todos</button>
                            <button class="btn-mini" onclick="toggleGroup('items-month', false, event)" data-i18n="sel_none">Ninguno</button>
                        </div>
                        <div class="dropdown-items" id="items-month"></div>
                    </div>
                </div>
            </div>

            <!-- ... dentro de index.html ... -->

            <div class="filter-group">
                <label data-i18n="filter_cats">Categor√≠as</label>
                <div class="custom-dropdown" id="drop-category">
                    <div class="dropdown-header" onclick="toggleDropdown('list-category')">
                        <span id="label-category" data-i18n="sel_select">Seleccionar...</span>
                        <i class="fa-solid fa-chevron-down"></i>
                    </div>
                    
                    <!-- INICIO MODIFICACI√ìN -->
                    <div id="list-category" class="dropdown-content">
                        <!-- Nuevo Campo de B√∫squeda -->
                        <div style="padding: 10px 10px 0 10px;">
                            <input type="text" id="cat-search-input" class="dropdown-search" placeholder="Buscar categor√≠a..." autocomplete="off">
                        </div>

                        <div class="dropdown-controls">
                            <button class="btn-mini" onclick="toggleGroup('items-category', true, event)" data-i18n="sel_all">Todos</button>
                            <button class="btn-mini" onclick="toggleGroup('items-category', false, event)" data-i18n="sel_none">Ninguno</button>
                        </div>
                        <div class="dropdown-items" id="items-category"></div>
                    </div>
                    <!-- FIN MODIFICACI√ìN -->

                </div>
            </div>
            <!-- BOT√ìN IA INFOGRAF√çA -->
            <button class="btn-ai-infographic" onclick="generateSmartInfographic()">
                <i class="fa-solid fa-wand-magic-sparkles"></i> 
                <span data-i18n="btn_ai_infographic">S√çNTESIS</span>
            </button>
            <div class="sidebar-footer">
                <img src="./ImagenCoorporativa/zzenkiu.png" alt="Zzenkiu" class="sidebar-logo">
            </div>
        </aside>

        <main class="main-content">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon"><i class="fa-solid fa-folder-open"></i></div>
                    <div class="kpi-data"><h3 data-i18n="kpi_expedientes">Expedientes</h3><span id="kpi-count">0</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #2dce89;"><i class="fa-solid fa-location-crosshairs"></i></div>
                     <div class="kpi-data"><h3 data-i18n="kpi_zona">Zona</h3><span id="kpi-location" data-i18n="kpi_waiting">Esperando...</span></div>
                </div>
                <!-- Busca esta parte y d√©jala as√≠: -->
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #fb6340;"><i class="fa-solid fa-calendar-check"></i></div>
                    <div class="kpi-data">
                        <h3 id="card-label-titulo" data-i18n="kpi_titulo">T√çTULO</h3> <!-- A√±adido data-i18n -->
                        <span id="card-text-filename">SIN ARCHIVO</span>
                    </div>
                </div>
            </div>

            <div class="charts-grid-top">
                <!-- GR√ÅFICO 1: EVOLUCI√ìN -->
                <div class="chart-container" id="container-timeline">
                    <div class="chart-header">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <!-- NUEVO: BOT√ìN DESCARGA -->
                            <button class="btn-mini" onclick="downloadComponent('container-timeline')" title="Descargar Imagen" style="border:none; background:transparent; padding:0; color:var(--accent-blue); cursor:pointer;">
                                <i class="fa-solid fa-download"></i>
                            </button>
                            <h4 data-i18n="chart_timeline">Evoluci√≥n</h4>
                        </div>
                        
                        <div class="header-actions">
                            <!-- Selector de periodo -->
                            <select id="select-temporal-view" class="btn-mini" onchange="changeTemporalView(this.value)">
                                <option value="year" data-i18n="view_years">Vista: A√±os</option>
                                <option value="month" selected data-i18n="view_months">Vista: Meses</option>
                                <option value="quarter" data-i18n="view_quarters">Vista: Trimestral</option>
                                <option value="day" data-i18n="view_days">Vista: D√≠as Semanal</option>
                            </select>
                            
                            <!-- Alternar entre Barras y L√≠neas -->
                            <button class="btn-mini" id="btn-toggle-chart-type" onclick="toggleTimelineType()" title="Cambiar a L√≠neas">
                                <i class="fa-solid fa-chart-line"></i>
                            </button>

                            <!-- Ver Tabla de Datos -->
                            <button class="btn-mini" id="btn-toggle-view" onclick="toggleTimelineView()" title="Ver Tabla de Datos">
                                <i class="fa-solid fa-table"></i>
                            </button>

                            <!-- Pantalla Completa -->
                            <button class="btn-maximize" onclick="toggleFullscreen('container-timeline')">
                                <i class="fa-solid fa-maximize"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="canvas-wrapper">
                        <canvas id="chart-timeline"></canvas>
                        <div id="table-timeline-view" class="table-view" style="display: none;"></div>
                    </div>
                </div>

                <!-- GR√ÅFICO 2: TOP TIPOS -->
                <div class="chart-container" id="container-category">
                    <div class="chart-header">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <!-- NUEVO: BOT√ìN DESCARGA -->
                            <button class="btn-mini" onclick="downloadComponent('container-category')" title="Descargar Imagen" style="border:none; background:transparent; padding:0; color:var(--accent-blue); cursor:pointer;">
                                <i class="fa-solid fa-download"></i>
                            </button>
                            <h4 data-i18n="chart_top">Top Tipos</h4>
                        </div>
                        
                        <div class="header-actions">
                            <button class="btn-mini" id="btn-toggle-view-cat" onclick="toggleCategoryView()" title="Ver Tabla de Datos">
                                <i class="fa-solid fa-table"></i>
                            </button>
                            <button class="btn-maximize" onclick="toggleFullscreen('container-category')">
                                <i class="fa-solid fa-maximize"></i>
                            </button>
                        </div>
                    </div>
                    <div class="canvas-wrapper">
                        <canvas id="chart-category"></canvas>
                        <div id="table-category-view" class="table-view" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <div class="bottom-grid">
                <!-- GR√ÅFICO 3: HORAS -->
                <div class="chart-container" id="container-hours">
                    <div class="chart-header">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <!-- NUEVO: BOT√ìN DESCARGA -->
                            <button class="btn-mini" onclick="downloadComponent('container-hours')" title="Descargar Imagen" style="border:none; background:transparent; padding:0; color:var(--accent-blue); cursor:pointer;">
                                <i class="fa-solid fa-download"></i>
                            </button>
                            <h4 data-i18n="chart_hours">Horas</h4>
                        </div>
                        
                        <div class="header-actions">
                            <!-- Bot√≥n Tabla Horas -->
                            <button class="btn-mini" id="btn-toggle-view-hours" onclick="toggleHoursView()" title="Ver Tabla de Datos">
                                <i class="fa-solid fa-table"></i>
                            </button>
                            <button class="btn-maximize" onclick="toggleFullscreen('container-hours')">
                                <i class="fa-solid fa-maximize"></i>
                            </button>
                        </div>
                    </div>
                    <div class="canvas-wrapper">
                        <canvas id="chart-hours"></canvas>
                        <!-- Tabla Horas -->
                        <div id="table-hours-view" class="table-view" style="display: none;"></div>
                    </div>
                </div>
                
                <!-- GR√ÅFICO 4: MAPA / LISTADO DE CALLES -->
                <div class="map-container-wrapper" id="container-map">
                    <div class="chart-header">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <!-- NUEVO: BOT√ìN DESCARGA -->
                            <button class="btn-mini" onclick="downloadComponent('container-map')" title="Descargar Imagen" style="border:none; background:transparent; padding:0; color:var(--accent-blue); cursor:pointer;">
                                <i class="fa-solid fa-download"></i>
                            </button>
                            <h4 data-i18n="chart_map">Mapa</h4>
                        </div>
                        
                        <div class="header-actions">
                            <!-- BOT√ìN LISTADO DE CALLES -->
                            <button class="btn-mini" id="btn-toggle-streets" onclick="toggleStreetsView()" title="Ver Listado de Calles">
                                <i class="fa-solid fa-list-ol"></i>
                            </button>

                            <!-- GESTOR DE CAPAS (Dropdown) -->
                            <div class="layer-manager-container" style="position: relative;">
                                <button class="btn-mini" id="btn-layers-menu" onclick="toggleLayerMenu()" title="Gestor de Capas">
                                    <i class="fa-solid fa-layer-group"></i>
                                </button>
                                
                                <div id="layers-dropdown" class="layer-dropdown-content">
                                    <div class="layer-header" style="flex-direction: column; align-items: flex-start; gap: 10px;">
                                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                                            <span data-i18n="map_layers_title">Mis Capas</span>
                                            <button id="btn-add-layer-icon" class="btn-add-layer" onclick="document.getElementById('input-geojson').click()" title="Subir GeoJSON">
                                                <i class="fa-solid fa-plus"></i>
                                            </button>
                                        </div>
                                        
                                        <div style="display:flex; align-items:center; gap:8px; font-size:0.7rem; color:#525f7f; width:100%; padding-top:5px; border-top:1px solid #eee;">
                                            <label class="switch">
                                                <input type="checkbox" id="chk-spatial-filter" onchange="triggerUpdateWithLoader()">
                                                <span class="slider round"></span>
                                            </label>
                                            <span data-i18n="map_filter_zone">Filtrar datos por zona</span>
                                        </div>
                                    </div>
                                    <div id="layers-list" class="layer-list-body">
                                        <p class="empty-layers-msg" data-i18n="map_no_layers">Sin capas cargadas</p>
                                    </div>
                                </div>
                            </div>

                            <!-- HERRAMIENTAS MAPA -->
                            <input type="file" id="input-geojson" accept=".geojson, .json" style="display: none;" onchange="handleGeojsonUpload(this)">
                            
                            <button class="btn-mini" id="btn-heatmap" onclick="toggleHeatmap(this)" title="Mapa de Calor">
                                <i class="fa-solid fa-fire"></i>
                            </button>
                            <!-- Agregado: Bot√≥n de An√°lisis Inteligente de Hotspots -->
                            <button class="btn-mini" id="btn-smart-focus" onclick="focusIntelligentHotspot()" title="Detectar Zona Cr√≠tica Autom√°ticamente">
                                <i class="fa-solid fa-wand-magic-sparkles"></i>
                            </button>
                            <button class="btn-mini" onclick="toggleSatelite(this)" title="Vista Sat√©lite">
                                <i class="fa-solid fa-earth-americas"></i>
                            </button>
                            
                            <button class="btn-mini" onclick="toggle3D()" title="Vista 3D">
                                <i class="fa-solid fa-cube"></i>
                            </button>
                            
                            <button class="btn-maximize" onclick="toggleFullscreen('container-map')" title="Pantalla Completa">
                                <i class="fa-solid fa-expand"></i>
                            </button>
                        </div>
                    </div>

                    <div class="canvas-wrapper">
                        <!-- VISTA DE MAPA -->
                        <div id="main-map"></div>
                        <!-- VISTA DE TABLA DE CALLES -->
                        <div id="table-streets-view" class="table-view" style="display: none;"></div>
                    </div>
                </div>
            </div>

    </div>
    <div class="canvas-wrapper">
        <div id="main-map"></div>
    </div>
</div>
            </div>
        </main>
    </section>

    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner-box">
            <div class="spinner"></div>
            <!-- A√ëADIDO data-i18n -->
            <p data-i18n="loading_msg">Procesando archivo...</p>
        </div>
    </div>
    <!-- MODAL DE REGISTROS DESCARTADOS -->
    <div id="rejected-modal" class="pdf-modal-overlay">
        <div class="pdf-modal-content" style="max-width: 550px; height: auto; max-height: 85vh;"> 
            <!-- Header Rojo -->
            <div class="pdf-header" style="background: #f5365c; color: white;"> 
                <h3><i class="fa-solid fa-triangle-exclamation"></i> Expedientes no integrados</h3>
                <button onclick="closeRejectedModal()" class="btn-close-pdf" style="color: white;"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="pdf-body">
                <p style="color: #ffffff; font-size: 15px; margin-bottom: 15px;">
                    Los siguientes expedientes <strong style="color: #ff8fa3;">no tienen fecha v√°lida</strong> y no se han incluido:
                </p>
                
                <div id="rejected-list" style="
                    background: #ffffff; 
                    border-radius: 8px; 
                    padding: 15px; 
                    max-height: 300px; 
                    overflow-y: auto; 
                    color: #333;
                    font-family: monospace;
                    font-weight: bold;">
                    <!-- Aqu√≠ se inyectan los datos v√≠a JS -->
                </div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button onclick="closeRejectedModal()" class="btn-primary" style="padding: 10px 20px;">ENTENDIDO</button>
                </div>
            </div>
        </div>
    </div>
    <div id="pdf-modal" class="pdf-modal-overlay">
        <div class="pdf-modal-content">
            <div class="pdf-header">
                <h3 id="pdf-modal-title"><i class="fa-solid fa-image"></i> Infograf√≠a</h3>
                <button onclick="closePdfModal()" class="btn-close-pdf"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="pdf-body">
                <!-- Iframe para PDFs (Oculto al abrir imagen) -->
                <iframe src="" id="pdf-frame" frameborder="0" style="display:none; width:100%; height:100%;"></iframe>
                
                <!-- Imagen adaptada -->
                <img id="img-frame" src="" style="display:none;">
            </div>
        </div>
    </div>

    <!-- NOTIFICACI√ìN FLOTANTE (TOAST) -->
    <div id="toast-notification" class="toast-notification">
        <i class="fa-solid fa-triangle-exclamation"></i>
        <span id="toast-message">Mensaje de aviso</span>
    </div>
    <!-- PLANTILLA OCULTA PARA GENERACI√ìN DE INFOGRAF√çA (ESTILO NOTEBOOK LM) -->
<div id="ai-infographic-container" class="infographic-canvas">
    <div class="info-header">
        <div class="header-text-group">
            <div class="info-tag" data-i18n="info_tag">EUROCOP ANALYTICS ‚Ä¢ SINTESIS</div>
            <h1 id="info-title">Resumen de Seguridad</h1>
            <p id="info-subtitle" data-i18n="info_subtitle">An√°lisis de datos filtrados</p>
        </div>
        <img src="./ImagenCoorporativa/zzenkiu.png" class="header-logo" alt="Logo Corporativo">
    </div>

    <div class="info-grid">
        <div class="info-card highlight-card">
            <div class="card-icon"><i class="fa-solid fa-bolt"></i> <span data-i18n="info_card_sintesis">SINTESIS PRINCIPAL</span></div>
            <h2 id="info-insight-main">...</h2>
        </div>

        <div class="info-card stats-card">
            <div class="stat-item">
                <span class="stat-label" data-i18n="info_lbl_total">TOTAL REGISTROS</span>
                <span class="stat-value" id="info-stat-total">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label" data-i18n="info_lbl_peak">PICO DE ACTIVIDAD</span>
                <span class="stat-value" id="info-stat-peak">--:--</span>
            </div>
            <div class="stat-item">
                <span class="stat-label" data-i18n="info_lbl_day">D√çA M√ÅS ACTIVO</span>
                <span class="stat-value" id="info-stat-day">---</span>
            </div>
        </div>

        <div class="info-card">
            <h3 data-i18n="info_lbl_trend">Tendencia Temporal</h3>
            <p id="info-text-trend" class="info-text-body" style="margin-bottom:15px;">...</p>
            
            <!-- NUEVA SECCI√ìN DE CALLES -->
            <h3 data-i18n="info_lbl_streets" style="border-top: 1px solid #eee; padding-top: 15px; margin-top: 5px;">Ubicaciones Cr√≠ticas</h3>
            <ul id="info-street-list" class="info-list" style="color: #4b5563;"></ul>
        </div>

        <div class="info-card dark-card">
            <h3 data-i18n="info_lbl_top3">Top 3 Categor√≠as</h3>
            <ul id="info-top-list" class="info-list"></ul>
        </div>
        
<!-- Tarjeta 5: Gr√°fico Comparativo -->
<div class="info-card graph-card">
    <h3 data-i18n="info_lbl_dominance">Dominancia</h3>
    <div class="comparison-layout">
        <!-- Gr√°fico Circular SVG -->
        <div class="svg-pie-container">
            <svg width="120" height="120" viewBox="0 0 120 120">
                <circle cx="60" cy="60" r="54" fill="none" stroke="#edf2f7" stroke-width="12" />
                <circle id="svg-pie-progress" cx="60" cy="60" r="54" fill="none" stroke="#5e72e4" 
                        stroke-width="12" stroke-linecap="round"
                        stroke-dasharray="339.29" stroke-dashoffset="339.29"
                        transform="rotate(-90 60 60)" />
            </svg>
            <div class="pie-inner-text">
                <span id="info-pie-percent">0%</span>
                <span class="pie-sublabel">TOTAL</span>
            </div>
        </div>
        
        <!-- Leyenda -->
        <div class="pie-legend">
            <div class="legend-row">
                <span class="dot-leader"></span>
                <div class="legend-content">
                    <span id="info-lbl-leader" class="legend-text">L√≠der</span>
                </div>
            </div>
            <div class="legend-row">
                <span class="dot-rest"></span>
                <div class="legend-content">
                    <!-- HE A√ëADIDO ESTE ID info-lbl-resto -->
                    <span id="info-lbl-resto" class="legend-text">Resto</span>
                </div>
            </div>
            <div class="pie-subtext" id="info-pie-subtext">0 vs 0</div>
        </div>
    </div>
</div>
    </div>

    <div class="info-footer">
        <span data-i18n="info_lbl_footer">Generado por Eurocop Analytics AI</span>
        <span id="info-date">--/--/----</span>
    </div>
</div>
    <!-- LIBRER√çAS EXTERNAS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
    
<!-- L√ìGICA Y SCRIPTS version-->
    <script src="languages.js"></script>
    <script src="FncConvertirPdf.js"></script>
    <script>
        document.write('<script src="script.js?v=' + EUROCOP_VERSION + '"><\/script>');
    </script>
<!-- MODAL PARA VER REGISTROS DETALLADOS -->
<div id="records-modal" class="pdf-modal-overlay">
    <div class="pdf-modal-content" style="max-width: 900px; width: 95%; height: 80vh;">
        <div class="pdf-header">
            <h3 id="records-modal-title">Registros Detallados</h3>
            <button onclick="closeRecordsModal()" class="btn-close-pdf"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="pdf-body" style="overflow: auto; background: white; padding: 0;">
            <div id="records-table-container"></div>
        </div>
    </div>
</div>
</body>
</html>