<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <!-- Viewport optimizado para prevenir zoom accidental en inputs -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eurocop Analytics | Seguridad Pública</title>
    
    <!-- FUENTES: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- ICONOS: FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ESTILOS MAPA: MapLibre GL JS -->
    <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
    
    <!-- ESTILOS PROPIOS -->
    <link rel="stylesheet" href="style.css">

    <!-- LIBRERÍAS PARA EXPORTACIÓN PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

    <!-- OVERLAY PARA MÓVIL (Fondo oscuro al abrir menú) -->
    <div id="mobile-overlay" class="mobile-overlay" onclick="toggleSidebarMobile()"></div>

    <!-- NAVBAR SUPERIOR -->
    <nav class="navbar">
        <!-- Izquierda: Logo y Botón Menú Móvil -->
        <div class="nav-left-group">
            <!-- Botón Hamburguesa (Solo Móvil) -->
            <button class="mobile-menu-btn" onclick="toggleSidebarMobile()">
                <i class="fa-solid fa-bars"></i>
            </button>
            
            <div class="logo" onclick="goToMapping()" style="cursor:pointer" title="Volver a Configuración">
                <span class="logo-icon"><i class="fa-solid fa-shield-halved"></i></span>
                <span class="logo-text">EUROCOP<span class="hide-mobile"> ANALYTICS</span><span class="dot">.</span></span>
            </div>
        </div>

        <!-- Derecha: Registros y Filtros -->
        <div class="nav-right">
            <div id="display-filename" class="filename-pill">SIN ARCHIVO</div>
            
            <span id="kpi-total-filas" class="badge-records">0 REG</span>
            <!-- La info detallada se oculta en móviles muy pequeños mediante CSS -->
            <div class="nav-filters-info">
                <span class="hide-mobile"><strong>AÑO:</strong> <span id="header-year" class="info-text">----</span> <span class="sep">|</span></span>
                <span class="hide-mobile"><strong>MES:</strong> <span id="header-month" class="info-text">----</span> <span class="sep">|</span></span>
                <span class="hide-mobile"><strong>CAT:</strong> <span id="header-category" class="info-text">----</span></span>
            </div>
        </div>
    </nav>

    <!-- VISTA 1: CARGA DE ARCHIVOS -->
<!-- VISTA 1: CARGA DE ARCHIVOS -->
    <section id="upload-view" class="view-container active">
        <div class="upload-center">
            <div class="upload-card">
                <div class="brand-circle">
                    <i class="fa-solid fa-file-import"></i>
                </div>
                <h1>Carga de Datos</h1>
                <p>Sube tu archivo Excel (.xlsx) o CSV.</p>
                
                <div class="drop-zone" id="drop-zone">
                    <i class="fa-solid fa-cloud-arrow-up upload-icon"></i>
                    <span>ARRASTRAR O TOCAR PARA SUBIR</span>
                    <input type="file" id="file-input" accept=".csv, .xlsx, .xls" hidden>
                </div>
                
                <div class="csv-info">
                    <small><i class="fa-solid fa-circle-info"></i> Compatible con móviles</small>
                </div>

                <!-- NUEVO: BOTÓN DE MANUAL PDF (CORREGIDO) -->
<!-- Dentro de <div class="upload-card"> ... -->

            <!-- BOTÓN QUE ABRE EL VISOR INTEGRADO -->
            <div class="manual-container">
                <button onclick="openPdfModal()" class="btn-manual-pill">
                    <i class="fa-solid fa-book-open"></i>
                    <span>Ver Manual de Ayuda</span>
                </button>
            </div>
                
            </div>
        </div>
    </section>

    <!-- VISTA 2: CONFIGURACIÓN -->
    <section id="mapping-view" class="view-container">
        <div class="config-panel">
            <div class="panel-header">
                <h2><i class="fa-solid fa-sliders"></i> CONFIGURACIÓN</h2>
                <p>Vincula las columnas de tu archivo.</p>
            </div>
            
            <div class="cards-grid mapping-layout">
                <!-- Las columnas se apilarán en móvil gracias a CSS Grid -->
                <div class="mapping-col">
                    <div class="card">
                        <label><strong>CONTADOR / ID</strong></label>
                        <select id="map-expediente" class="styled-select"></select>
                    </div>
                    <div class="card">
                        <label><strong>LATITUD (Y)</strong></label>
                        <select id="map-lat" class="styled-select"></select>
                    </div>
                    <div class="card">
                        <label><strong>LONGITUD (X)</strong></label>
                        <select id="map-lon" class="styled-select"></select>
                    </div>
                </div>

                <div class="mapping-col">
                    <div class="card full-height">
                        <div style="margin-bottom: 25px;">
                            <label><strong>FECHA (Obligatorio)</strong></label>
                            <select id="map-fecha" class="styled-select"></select>
                        </div>
                        <div>
                            <label><strong>HORA (Opcional)</strong></label>
                            <select id="map-hora" class="styled-select"></select>
                        </div>
                    </div>
                </div>

                <!-- COLUMNA 3: CATEGORÍA Y LOCALIDAD -->
                <div class="mapping-col">
                    <!-- Tarjeta Categoría -->
                    <div class="card highlighted-card">
                        <div class="highlight-badge">ANÁLISIS</div>
                        <label><strong>CATEGORÍA / TIPO</strong></label>
                        <p class="card-desc">Selecciona la columna que define el tipo de incidencia.</p>
                        <select id="map-categoria" class="styled-select select-accent"></select>
                    </div>

                    <!-- NUEVA TARJETA: LOCALIDAD (TEXTO LIBRE) -->
                    <div class="card">
                        <label><strong>LOCALIDAD (Opcional)</strong></label>
                        <p class="card-desc">Escribe el nombre para forzar la zona. Déjalo vacío para GPS.</p>
                        <!-- CAMBIO: Ahora es un input de texto, no un select -->
                        <input type="text" id="map-localidad" class="styled-select" placeholder="Ej: DURANGO" autocomplete="off">
                    </div>
                </div>
            </div>
            
            <div class="action-footer">
                <button onclick="location.reload()" class="btn-mini">Cancelar</button>
                <button id="btn-visualizar" class="btn-primary">GENERAR DASHBOARD</button>
            </div>
        </div>
    </section>

    <!-- VISTA 3: DASHBOARD INTERACTIVO -->
    <section id="dashboard-view" class="view-container">
        
        <!-- SIDEBAR DE FILTROS (Off-canvas en móvil) -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header-mobile">
                <h3>Filtros</h3>
                <button class="btn-close-sidebar" onclick="toggleSidebarMobile()"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="sidebar-actions">
                <button class="btn-export-pdf" onclick="FncConvertirPdf.exportar()">
                    <i class="fa-solid fa-file-pdf"></i> EXPORTAR A PDF
                </button>
            </div>

            <div class="filter-header"><i class="fa-solid fa-filter"></i> FILTROS AVANZADOS</div>
            
            <!-- Filtro Años -->
            <div class="filter-group">
                <label>Años</label>
                <div class="custom-dropdown" id="drop-year">
                    <div class="dropdown-header" onclick="toggleDropdown('list-year')">
                        <span id="label-year">Seleccionar...</span>
                        <i class="fa-solid fa-chevron-down"></i>
                    </div>
                    <div id="list-year" class="dropdown-content">
                        <div class="dropdown-controls">
                            <button class="btn-mini" onclick="toggleGroup('items-year', true, event)">Todos</button>
                            <button class="btn-mini" onclick="toggleGroup('items-year', false, event)">Ninguno</button>
                        </div>
                        <div class="dropdown-items" id="items-year"></div>
                    </div>
                </div>
            </div>

            <!-- Filtro Meses -->
            <div class="filter-group">
                <label>Meses</label>
                <div class="custom-dropdown" id="drop-month">
                    <div class="dropdown-header" onclick="toggleDropdown('list-month')">
                        <span id="label-month">Seleccionar...</span>
                        <i class="fa-solid fa-chevron-down"></i>
                    </div>
                    <div id="list-month" class="dropdown-content">
                        <div class="dropdown-controls">
                            <button class="btn-mini" onclick="toggleGroup('items-month', true, event)">Todos</button>
                            <button class="btn-mini" onclick="toggleGroup('items-month', false, event)">Ninguno</button>
                        </div>
                        <div class="dropdown-items" id="items-month"></div>
                    </div>
                </div>
            </div>

            <!-- Filtro Categorías -->
            <div class="filter-group">
                <label>Categorías</label>
                <div class="custom-dropdown" id="drop-category">
                    <div class="dropdown-header" onclick="toggleDropdown('list-category')">
                        <span id="label-category">Seleccionar...</span>
                        <i class="fa-solid fa-chevron-down"></i>
                    </div>
                    <div id="list-category" class="dropdown-content">
                        <div class="dropdown-controls">
                            <button class="btn-mini" onclick="toggleGroup('items-category', true, event)">Todos</button>
                            <button class="btn-mini" onclick="toggleGroup('items-category', false, event)">Ninguno</button>
                        </div>
                        <div class="dropdown-items" id="items-category"></div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- CONTENIDO PRINCIPAL -->
        <main class="main-content">
            <!-- KPIs SUPERIORES -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon"><i class="fa-solid fa-folder-open"></i></div>
                    <div class="kpi-data"><h3>Expedientes</h3><span id="kpi-count">0</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #2dce89;"><i class="fa-solid fa-location-crosshairs"></i></div>
                     <div class="kpi-data"><h3>Zona</h3><span id="kpi-location">Esperando...</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #fb6340;"><i class="fa-solid fa-calendar-check"></i></div>
                    <div class="kpi-data"><h3>Periodo</h3><span>Filtrado</span></div>
                </div>
            </div>

            <!-- GRÁFICOS SUPERIORES -->
            <div class="charts-grid-top">
            <div class="chart-container" id="container-timeline">
                <div class="chart-header">
                    <h4>Evolución Temporal</h4>
                    <div class="header-actions">
                        <!-- Selector de Vista (Año/Mes/Día) -->
                        <select id="select-temporal-view" class="btn-mini" onchange="changeTemporalView(this.value)">
                            <option value="year">Vista: Años</option>
                            <option value="month" selected>Vista: Meses</option>
                            <option value="day">Vista: Días Semanal</option>
                        </select>
                        
                        <!-- NUEVO: Botón alternar Gráfico / Tabla -->
                        <button class="btn-mini" id="btn-toggle-view" onclick="toggleTimelineView()" title="Ver Tabla de Datos">
                            <i class="fa-solid fa-table"></i>
                        </button>

                        <!-- Botón Maximizar -->
                        <button class="btn-maximize" onclick="toggleFullscreen('container-timeline')">
                            <i class="fa-solid fa-maximize"></i>
                        </button>
                    </div>
                </div>
                
                <div class="canvas-wrapper">
                    <!-- El Canvas del Gráfico -->
                    <canvas id="chart-timeline"></canvas>
                    
                    <!-- NUEVO: El Contenedor de la Tabla (Oculto por defecto) -->
                    <div id="table-timeline-view" class="table-view" style="display: none;"></div>
                </div>
            </div>

            <div class="chart-container" id="container-category">
                <div class="chart-header">
                    <h4>Top Tipos</h4>
                    <div class="header-actions">
                        <!-- NUEVO: Botón alternar Tabla/Gráfico -->
                        <button class="btn-mini" id="btn-toggle-view-cat" onclick="toggleCategoryView()" title="Ver Tabla de Datos">
                            <i class="fa-solid fa-table"></i>
                        </button>
                        
                        <!-- Botón Maximizar -->
                        <button class="btn-maximize" onclick="toggleFullscreen('container-category')">
                            <i class="fa-solid fa-maximize"></i>
                        </button>
                    </div>
                </div>
                <div class="canvas-wrapper">
                    <canvas id="chart-category"></canvas>
                    <!-- NUEVO: Contenedor para la tabla -->
                    <div id="table-category-view" class="table-view" style="display: none;"></div>
                </div>
            </div>
            </div>

            <!-- MAPA Y HORAS -->
            <div class="bottom-grid">
                <div class="chart-container" id="container-hours">
                    <div class="chart-header">
                        <h4>Horas</h4>
                        <button class="btn-maximize" onclick="toggleFullscreen('container-hours')">
                            <i class="fa-solid fa-maximize"></i>
                        </button>
                    </div>
                    <div class="canvas-wrapper"><canvas id="chart-hours"></canvas></div>
                </div>
                
                <div class="map-container-wrapper" id="container-map">
                    <div class="chart-header">
                        <h4>Mapa</h4>
                        <div class="header-actions">
                            <button class="btn-mini" id="btn-heatmap" onclick="toggleHeatmap(this)">
                                <i class="fa-solid fa-fire"></i>
                            </button>
                            <button class="btn-mini" onclick="toggleSatelite(this)">
                                <i class="fa-solid fa-earth-americas"></i>
                            </button>
                            <button class="btn-mini" onclick="toggle3D()">
                                <i class="fa-solid fa-cube"></i>
                            </button>
                            <button class="btn-maximize" onclick="toggleFullscreen('container-map')">
                                <i class="fa-solid fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="canvas-wrapper">
                        <div id="main-map"></div>
                    </div>
                </div>
            </div>
        </main>
    </section>
    <!-- NUEVO: LOADING OVERLAY (Indicador de carga) -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner-box">
            <div class="spinner"></div>
            <p>Procesando archivo...</p>
            <small>Esto puede tardar unos segundos si el archivo es grande.</small>
        </div>
    </div>
    <!-- MODAL VISOR PDF (NUEVO) -->
    <div id="pdf-modal" class="pdf-modal-overlay">
        <div class="pdf-modal-content">
            <div class="pdf-header">
                <h3><i class="fa-solid fa-book"></i> Manual de Usuario</h3>
                <button onclick="closePdfModal()" class="btn-close-pdf"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="pdf-body">
                <!-- AQUÍ CARGAMOS EL ARCHIVO manual.pdf -->
                <iframe src="./manual.pdf" id="pdf-frame" frameborder="0"></iframe>
            </div>
        </div>
    </div>
</body>
</html>
    <!-- LIBRERÍAS EXTERNAS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
    
    <!-- LÓGICA -->
    <script src="script.js"></script>
    <script src="FncConvertirPdf.js"></script>

</body>
</html>