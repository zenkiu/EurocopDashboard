<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eurocop Analytics | Seguridad Pública</title>
    
    <!-- FUENTES: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- ICONOS: FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ESTILOS MAPA: MapLibre GL JS -->
    <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
    
    <!-- ESTILOS PROPIOS -->
    <link rel="stylesheet" href="style.css">

    <!-- LIBRERÍAS PARA EXPORTACIÓN PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

    <!-- =========================================
       NAVBAR SUPERIOR
    ========================================== -->
    <nav class="navbar">
        <!-- Izquierda: Logo (Con función para regresar) -->
        <div class="logo" onclick="goToMapping()" style="cursor:pointer" title="Volver a Configuración">
            <span class="logo-icon"><i class="fa-solid fa-shield-halved"></i></span>
            <span class="logo-text">EUROCOP ANALYTICS<span class="dot">.</span></span>
        </div>

        <!-- Centro: Nombre del archivo -->
        <div class="nav-center">
            <div id="display-filename" class="filename-pill">SIN ARCHIVO CARGADO</div>
        </div>

        <!-- Derecha: Registros y Filtros Dinámicos -->
        <!-- Busca la clase nav-filters-info y añade la línea de CAT -->
        <div class="nav-right">
            <span id="kpi-total-filas" class="badge-records">0 REGISTROS</span>
            <div class="nav-filters-info">
                <strong>AÑO:</strong> <span id="header-year">----</span>
                <strong>MES:</strong> <span id="header-month">----</span>
                <!-- NUEVO CAMPO ABAJO -->
                <strong style="margin-left: 10px;">CAT:</strong> <span id="header-category">----</span>
            </div>
        </div>
    </nav>

    <!-- =========================================
       VISTA 1: CARGA DE ARCHIVOS
    ========================================== -->
    <section id="upload-view" class="view-container active">
        <div class="upload-center">
            <div class="upload-card">
                <div class="brand-circle">
                    <i class="fa-solid fa-file-import"></i>
                </div>
                <h1>Carga de Datos</h1>
                <p>Sube tu archivo Excel (.xlsx) o CSV para comenzar el análisis.</p>
                
                <div class="drop-zone" id="drop-zone">
                    <i class="fa-solid fa-cloud-arrow-up upload-icon"></i>
                    <span>ARRASTRAR O HACER CLIC</span>
                    <input type="file" id="file-input" accept=".csv, .xlsx, .xls" hidden>
                </div>
                <div class="csv-info">
                    <small><i class="fa-solid fa-circle-info"></i> El sistema procesará coordenadas y categorías automáticamente.</small>
                </div>
            </div>
        </div>
    </section>

    <!-- =========================================
       VISTA 2: CONFIGURACIÓN (MAPEO EN 3 COLUMNAS)
    ========================================== -->
    <section id="mapping-view" class="view-container">
        <div class="config-panel">
            <div class="panel-header">
                <h2><i class="fa-solid fa-sliders"></i> CONFIGURACIÓN DE CAMPOS</h2>
                <p>Relaciona las columnas de tu archivo con los datos del sistema.</p>
            </div>
            
            <div class="cards-grid mapping-layout">
                <!-- COLUMNA 1: 3 FILAS (CONTADOR, LAT, LON) -->
                <div class="mapping-col">
                    <div class="card">
                        <label><strong>CONTADOR / ID</strong></label>
                        <select id="map-expediente" class="styled-select"></select>
                    </div>
                    <div class="card">
                        <label><strong>LATITUD (Y)</strong></label>
                        <select id="map-lat" class="styled-select"></select>
                    </div>
                    <div class="card">
                        <label><strong>LONGITUD (X)</strong></label>
                        <select id="map-lon" class="styled-select"></select>
                    </div>
                </div>

                <!-- COLUMNA 2: FECHA Y HORA -->
                <div class="mapping-col">
                    <div class="card full-height">
                        <div style="margin-bottom: 25px;">
                            <label><strong>FECHA (Obligatorio)</strong></label>
                            <select id="map-fecha" class="styled-select"></select>
                        </div>
                        <div>
                            <label><strong>HORA (Opcional)</strong></label>
                            <select id="map-hora" class="styled-select"></select>
                        </div>
                    </div>
                </div>

                <!-- COLUMNA 3: CATEGORÍA (Diferenciada) -->
                <div class="mapping-col">
                    <div class="card full-height highlighted-card">
                        <div class="highlight-badge">ANÁLISIS</div>
                        <label><strong>CATEGORÍA / TIPO</strong></label>
                        <p class="card-desc">Selecciona la columna que define el tipo de incidencia para clasificar los datos.</p>
                        <select id="map-categoria" class="styled-select select-accent"></select>
                    </div>
                </div>
            </div>
            
            <div class="action-footer">
                <button onclick="location.reload()" class="btn-mini">Cancelar</button>
                <button id="btn-visualizar" class="btn-primary">GENERAR DASHBOARD</button>
            </div>
        </div>
    </section>

    <!-- =========================================
       VISTA 3: DASHBOARD INTERACTIVO
    ========================================== -->
    <section id="dashboard-view" class="view-container">
        
        <!-- SIDEBAR DE FILTROS -->
<aside class="sidebar">
    <div class="sidebar-actions">
        <button class="btn-export-pdf" onclick="FncConvertirPdf.exportar()">
            <i class="fa-solid fa-file-pdf"></i> EXPORTAR A PDF (A4)
        </button>
    </div>

    <div class="filter-header"><i class="fa-solid fa-filter"></i> FILTROS AVANZADOS</div>
    
    <!-- Filtro Años -->
    <div class="filter-group">
        <label>Años</label>
        <div class="custom-dropdown" id="drop-year">
            <div class="dropdown-header" onclick="toggleDropdown('list-year')">
                <span id="label-year">Seleccionar...</span>
                <i class="fa-solid fa-chevron-down"></i>
            </div>
            <div id="list-year" class="dropdown-content">
                <div class="dropdown-controls">
                    <button class="btn-mini" onclick="toggleGroup('items-year', true, event)">Todos</button>
                    <button class="btn-mini" onclick="toggleGroup('items-year', false, event)">Ninguno</button>
                </div>
                <div class="dropdown-items" id="items-year"></div>
            </div>
        </div>
    </div>

    <!-- Filtro Meses -->
    <div class="filter-group">
        <label>Meses</label>
        <div class="custom-dropdown" id="drop-month">
            <div class="dropdown-header" onclick="toggleDropdown('list-month')">
                <span id="label-month">Seleccionar...</span>
                <i class="fa-solid fa-chevron-down"></i>
            </div>
            <div id="list-month" class="dropdown-content">
                <div class="dropdown-controls">
                    <button class="btn-mini" onclick="toggleGroup('list-month', true)">Todos</button>
                    <button class="btn-mini" onclick="toggleGroup('list-month', false)">Ninguno</button>
                </div>
                <div class="dropdown-items" id="items-month"></div>
            </div>
        </div>
    </div>

    <!-- Filtro Categorías -->
    <div class="filter-group">
        <label>Categorías</label>
        <div class="custom-dropdown" id="drop-category">
            <div class="dropdown-header" onclick="toggleDropdown('list-category')">
                <span id="label-category">Seleccionar...</span>
                <i class="fa-solid fa-chevron-down"></i>
            </div>
            <div id="list-category" class="dropdown-content">
                <div class="dropdown-controls">
                    <button class="btn-mini" onclick="toggleGroup('list-category', true)">Todos</button>
                    <button class="btn-mini" onclick="toggleGroup('list-category', false)">Ninguno</button>
                </div>
                <div class="dropdown-items" id="items-category"></div>
            </div>
        </div>
    </div>
</aside>

        <!-- CONTENIDO PRINCIPAL -->
        <main class="main-content">
            <!-- KPIs SUPERIORES -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon"><i class="fa-solid fa-folder-open"></i></div>
                    <div class="kpi-data"><h3>Expedientes</h3><span id="kpi-count">0</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #2dce89;"><i class="fa-solid fa-location-crosshairs"></i></div>
                    <div class="kpi-data"><h3>Zona Principal</h3><span>Durango / Local</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #fb6340;"><i class="fa-solid fa-calendar-check"></i></div>
                    <div class="kpi-data"><h3>Periodo</h3><span>Filtrado</span></div>
                </div>
            </div>

            <!-- GRÁFICOS SUPERIORES -->
            <div class="charts-grid-top">
                <div class="chart-container" id="container-timeline">
                    <div class="chart-header">
                        <h4>Evolución Temporal</h4>
                        <div class="header-actions">
                            <select id="select-temporal-view" class="btn-mini" onchange="changeTemporalView(this.value)">
                                <option value="year">Vista: Años</option>
                                <option value="month">Vista: Meses</option>
                                <option value="day">Vista: Días Semanal</option>
                            </select>
                            <button class="btn-maximize" onclick="toggleFullscreen('container-timeline')">
                                <i class="fa-solid fa-maximize"></i>
                            </button>
                        </div>
                    </div>
                    <div class="canvas-wrapper"><canvas id="chart-timeline"></canvas></div>
                </div>

                <div class="chart-container" id="container-category">
                    <div class="chart-header">
                        <h4>Top Categorías</h4>
                        <button class="btn-maximize" onclick="toggleFullscreen('container-category')">
                            <i class="fa-solid fa-maximize"></i>
                        </button>
                    </div>
                    <div class="canvas-wrapper"><canvas id="chart-category"></canvas></div>
                </div>
            </div>

            <!-- MAPA Y HORAS -->
            <div class="bottom-grid">
                <div class="chart-container" id="container-hours">
                    <div class="chart-header">
                        <h4>Actividad por Horas</h4>
                        <button class="btn-maximize" onclick="toggleFullscreen('container-hours')">
                            <i class="fa-solid fa-maximize"></i>
                        </button>
                    </div>
                    <div class="canvas-wrapper"><canvas id="chart-hours"></canvas></div>
                </div>
                
                <div class="map-container-wrapper" id="container-map">
                    <div class="chart-header">
                        <h4>Mapa de Calor e Incidencias</h4>
                        <div class="header-actions">
                            <button class="btn-mini" id="btn-heatmap" onclick="toggleHeatmap(this)">
                                <i class="fa-solid fa-fire"></i> Modo: Calor
                            </button>
                            <button class="btn-mini" onclick="toggleSatelite(this)">
                                <i class="fa-solid fa-earth-americas"></i> Satélite
                            </button>
                            <button class="btn-mini" onclick="toggle3D()">
                                <i class="fa-solid fa-cube"></i> 3D
                            </button>
                            <button class="btn-maximize" onclick="toggleFullscreen('container-map')">
                                <i class="fa-solid fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="canvas-wrapper">
                        <div id="main-map"></div>
                    </div>
                </div>
            </div>
        </main>
    </section>

    <!-- LIBRERÍAS EXTERNAS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
    
    <!-- LÓGICA -->
    <script src="script.js"></script>
    <script src="FncConvertirPdf.js"></script>

</body>
</html>