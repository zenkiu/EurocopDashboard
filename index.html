<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eurocop Analytics | Seguridad P√∫blica</title>
    <link rel="icon" href="./ImagenCoorporativa/zzenkiu.png" type="image/png">
    
    <!-- FUENTES: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- ICONOS: FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ESTILOS MAPA: MapLibre GL JS -->
    <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
    
    <!-- CONTROL DE VERSIONES Y CARGA CSS -->
    <script src="version.js"></script>
    <script>
        document.write('<link rel="stylesheet" href="style.css?v=' + EUROCOP_VERSION + '">');
    </script>

    <!-- LIBRER√çAS EXTERNAS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
</head>
<body>

    <!-- OVERLAY PARA M√ìVIL -->
    <div id="mobile-overlay" class="mobile-overlay" onclick="toggleSidebarMobile()"></div>

    <!-- NAVBAR SUPERIOR -->
    <nav class="navbar">
        <div class="nav-left-group">
            <button class="mobile-menu-btn" onclick="toggleSidebarMobile()">
                <i class="fa-solid fa-bars"></i>
            </button>
            
            <div class="logo">
                <span class="logo-icon"><i class="fa-solid fa-shield-halved"></i></span>
                <span class="logo-text" onclick="goToMapping()" style="cursor:pointer" title="Volver a Configuraci√≥n">
                    <span data-i18n="nav_title">EUROCOP</span>
                    <span class="hide-mobile" data-i18n="nav_analytics"> ANALYTICS</span>
                    <span class="dot">.</span>
                </span>
            </div>
        </div>

        <div class="nav-right">
            <!-- SELECTOR DE IDIOMA -->
            <select id="lang-selector" class="lang-select" onchange="changeLanguage(this.value)">
                <option value="es">üî¥ ES</option>
                <option value="eu">üü¢ EU</option>
                <option value="ca">üü° CA</option>
                <option value="gl">üîµ GL</option>
            </select>

            <span id="kpi-total-filas" class="badge-records">0 <span data-i18n="kpi_reg">REG</span></span>
            
            <div class="nav-filters-info">
                <span class="hide-mobile"><strong data-i18n="lbl_year">A√ëO:</strong> <span id="header-year" class="info-text">----</span> <span class="sep">|</span></span>
                <span class="hide-mobile"><strong data-i18n="lbl_month">MES:</strong> <span id="header-month" class="info-text">----</span> <span class="sep">|</span></span>
                <span class="hide-mobile"><strong data-i18n="lbl_cat">CAT:</strong> <span id="header-category" class="info-text">----</span></span>
            </div>
        </div>
    </nav>

    <!-- VISTA 1: CARGA DE ARCHIVOS -->
    <section id="upload-view" class="view-container active">
        <div class="upload-center">
            <div class="upload-card">
                <div class="brand-circle">
                    <i class="fa-solid fa-file-import"></i>
                </div>
                <h1 data-i18n="upload_title">Carga de Datos</h1>
                <p data-i18n="upload_desc">Sube tu archivo Excel (.xlsx) o CSV.</p>
                
                <div class="drop-zone" id="drop-zone">
                    <i class="fa-solid fa-cloud-arrow-up upload-icon"></i>
                    <span data-i18n="upload_drop">ARRASTRAR O TOCAR PARA SUBIR</span>
                    <input type="file" id="file-input" accept=".csv, .xlsx, .xls" hidden>
                </div>
                
                <div class="csv-info">
                    <small class="clickable-info" onclick="openImageModal('./ImagenCoorporativa/Infografia.png', 'Infograf√≠a')">
                        <i class="fa-solid fa-circle-info"></i> 
                        <span data-i18n="upload_mobile">Compatible con m√≥viles</span>
                    </small>
                </div>

                <div class="manual-container">
                    <button onclick="openPdfModal('Manual.pdf', 'Manual de Ayuda')" class="btn-manual-pill">
                        <i class="fa-solid fa-book-open"></i>
                        <span data-i18n="btn_manual">Ver Manual</span>
                    </button>

                    <button onclick="openPdfModal('Actualizaciones.pdf', 'Novedades y Actualizaciones')" class="btn-manual-pill">
                        <i class="fa-solid fa-rotate"></i>
                        <span data-i18n="btn_updates">Actualizaciones</span>
                    </button>

                    <a href="https://www.youtube.com/playlist?list=PL0ocQ3pHMwQsPcyIqnI7D1H6NIwqwsoyZ" target="_blank" class="btn-manual-pill" style="text-decoration: none;">
                        <i class="fa-brands fa-youtube"></i>
                        <span data-i18n="btn_videos">VideoTutoriales</span>
                    </a>

                    <a href="./EurocopMemorias/EurocopMemorias.zip" download class="btn-manual-pill" style="text-decoration: none;">
                        <i class="fa-solid fa-file-zipper"></i>
                        <span data-i18n="btn_memorias">Memorias</span>
                    </a>
                </div>

                <div class="brand-footer">
                    <span class="brand-label" data-i18n="brand_powered">Powered by</span>
                    <img src="./ImagenCoorporativa/zzenkiu.png" alt="Zzenkiu" class="brand-logo">
                    <div id="app-version-badge" class="version-badge"></div> 
                </div>
            </div>
        </div>
    </section>

    <!-- VISTA 2: CONFIGURACI√ìN (Mapeo) -->
    <section id="mapping-view" class="view-container">
        <div class="config-panel">
            <div class="panel-header">
                <h2 data-i18n="config_title"><i class="fa-solid fa-sliders"></i> CONFIGURACI√ìN</h2>
                <p data-i18n="config_desc">Vincula las columnas de tu archivo.</p>
            </div>

            <div style="margin-bottom: 15px; text-align: center;">
                <button id="toggle-configured-fields" onclick="toggleConfiguredFields()" class="btn-toggle-fields">
                    <i class="fa-solid fa-eye"></i> <span id="toggle-text" data-i18n="btn_show_configured">Mostrar campos configurados</span>
                </button>
            </div>
            
            <div class="cards-grid mapping-layout" id="mapping-grid">
                <!-- SECCI√ìN CONFIGURADA COL 1: Contador, Lat, Lon -->
                <div class="mapping-col configured-fields-section" style="display: none;">
                    <div class="card">
                        <label><strong data-i18n="col_id">CONTADOR / ID</strong></label>
                        <select id="map-expediente" class="styled-select configured-field"></select>
                    </div>
                    <div class="card">
                        <label><strong>LATITUD (Y)</strong></label>
                        <select id="map-lat" class="styled-select configured-field"></select>
                    </div>
                    <div class="card">
                        <label><strong>LONGITUD (X)</strong></label>
                        <select id="map-lon" class="styled-select configured-field"></select>
                    </div>
                </div>

                <!-- SECCI√ìN CONFIGURADA COL 2: Fecha, Hora, Calle -->
                <div class="mapping-col configured-fields-section" style="display: none;">
                    <div class="card">
                        <label><strong data-i18n="col_date">FECHA (Obligatorio)</strong></label>
                        <select id="map-fecha" class="styled-select configured-field"></select>
                    </div>
                    <div class="card">
                        <label><strong data-i18n="col_time">HORA (Opcional)</strong></label>
                        <select id="map-hora" class="styled-select configured-field"></select>
                    </div>
                    <div class="card">
                        <label><strong data-i18n="col_street">CALLE / DIRECCI√ìN (Opcional)</strong></label>
                        <select id="map-calle" class="styled-select configured-field"></select>
                    </div>
                </div>

                <!-- SECCI√ìN AN√ÅLISIS (Siempre visible) -->
                <div class="mapping-col visible-fields-section">
                    <div class="card highlighted-card">
                        <div class="highlight-badge">AN√ÅLISIS</div>
                        <label><strong data-i18n="col_cat">CATEGOR√çA / TIPO</strong></label>
                        <select id="map-categoria" class="styled-select select-accent"></select>
                    </div>

                    <!-- CONTENEDOR FILTROS EXTRA -->
                    <div id="extra-filters-config-group" style="display: none; flex-direction: column; gap: 20px;">
                        <div class="card" style="border-left: 4px solid var(--accent-blue); background: #f0f4ff;">
                            <label><strong data-i18n="extra_filter_1">FILTRO EXTRA 1</strong></label>
                            <select id="map-filtro-1" class="styled-select"></select>
                        </div>
                        <div class="card" style="border-left: 4px solid var(--accent-blue); background: #f0f4ff;">
                            <label><strong data-i18n="extra_filter_2">FILTRO EXTRA 2</strong></label>
                            <select id="map-filtro-2" class="styled-select"></select>
                        </div>
                    </div>

                    <div class="card">
                        <label><strong data-i18n="col_loc">LOCALIDAD (Opcional)</strong></label>
                        <input type="text" id="map-localidad" class="styled-select" placeholder="Ej: DURANGO" autocomplete="off">
                    </div>
                </div>
            </div>
            
            <div class="action-footer">
                <button onclick="location.reload()" class="btn-mini" data-i18n="btn_cancel">Cancelar</button>
                <button id="btn-visualizar" class="btn-primary" data-i18n="btn_generate">GENERAR DASHBOARD</button>
            </div>
        </div>
    </section>

    <!-- VISTA 3: DASHBOARD -->
    <section id="dashboard-view" class="view-container">
        
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header-mobile">
                <h3 data-i18n="sidebar_filters">Filtros</h3>
                <button class="btn-close-sidebar" onclick="toggleSidebarMobile()"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="sidebar-actions">
                <button class="btn-export-pdf" onclick="FncConvertirPdf.exportar()">
                    <i class="fa-solid fa-file-pdf"></i> <span data-i18n="btn_export">EXPORTAR A PDF</span>
                </button>
            </div>

            <div class="filter-header"><i class="fa-solid fa-filter"></i> <span data-i18n="filter_header">FILTROS AVANZADOS</span></div>
            
            <!-- Bot√≥n Cambio de Modo Fecha -->
            <div style="margin-bottom: 15px; text-align: center;">
                <button id="toggle-date-mode" onclick="toggleDateFilterMode()" style="
                    background: #f7fafc; 
                    border: 1px solid #e2e8f0; 
                    padding: 10px 16px; 
                    border-radius: 8px; 
                    cursor: pointer; 
                    font-size: 13px; 
                    font-weight: 600;
                    color: #4a5568;
                    transition: all 0.2s;
                    width: 100%;">
                    <i class="fa-solid fa-calendar-days"></i> <span id="date-mode-text" data-i18n="btn_date_range_mode">Modo: Desde - Hasta</span>
                </button>
            </div>

            <!-- Filtro de A√±os -->
            <div class="filter-group">
                <label data-i18n="filter_years">A√±os</label>
                <div class="custom-dropdown" id="drop-year">
                    <div class="dropdown-header" onclick="toggleDropdown('list-year')">
                        <span id="label-year">----</span>
                        <i class="fa-solid fa-chevron-down"></i>
                    </div>
                    <div id="list-year" class="dropdown-content">
                        <div class="dropdown-controls" style="padding: 10px 10px 5px 10px;">
                            <button class="btn-mini" onclick="toggleGroup('items-year', true, event)" title="Todos"><i class="fa-solid fa-check-double"></i></button>
                            <button class="btn-mini" onclick="toggleGroup('items-year', false, event)" title="Ninguno"><i class="fa-solid fa-minus"></i></button>
                        </div>
                        <div class="dropdown-items" id="items-year"></div>
                    </div>
                </div>
            </div>

            <!-- Modo 1: Meses (Tradicional) -->
            <div id="filter-month-mode">
                <div class="filter-group">
                    <label data-i18n="filter_months">Meses</label>
                    <div class="custom-dropdown" id="drop-month">
                        <div class="dropdown-header" onclick="toggleDropdown('list-month')">
                            <span id="label-month">----</span>
                            <i class="fa-solid fa-chevron-down"></i>
                        </div>
                        <div id="list-month" class="dropdown-content">
                            <div class="dropdown-controls" style="padding: 10px 10px 5px 10px;">
                                <button class="btn-mini" onclick="toggleGroup('items-month', true, event)" title="Todos"><i class="fa-solid fa-check-double"></i></button>
                                <button class="btn-mini" onclick="toggleGroup('items-month', false, event)" title="Ninguno"><i class="fa-solid fa-minus"></i></button>
                            </div>
                            <div class="dropdown-items" id="items-month"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modo 2: Rango D√≠a/Mes (Dise√±o de 2 columnas restaurado) -->
            <div id="filter-daymonth-mode" style="display: none;">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <label data-i18n="filter_daymonth_from" style="font-size: 0.7rem; font-weight: 700; color: var(--text-muted); margin-bottom: 5px; display: block; text-transform: uppercase;">Desde</label>
                        <input type="text" id="daymonth-from-input" class="daymonth-input" placeholder="DD/MM" maxlength="5" 
                            style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; color: var(--text-dark); background: white;">
                    </div>
                    <div style="flex: 1;">
                        <label data-i18n="filter_daymonth_to" style="font-size: 0.7rem; font-weight: 700; color: var(--text-muted); margin-bottom: 5px; display: block; text-transform: uppercase;">Hasta</label>
                        <input type="text" id="daymonth-to-input" class="daymonth-input" placeholder="DD/MM" maxlength="5"
                            style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; color: var(--text-dark); background: white;">
                    </div>
                </div>
                <button onclick="triggerUpdateWithLoader()" style="width: 100%; padding: 8px; background: var(--primary-color, #5e72e4); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 15px;" data-i18n="btn_apply_filter">
                    <i class="fa-solid fa-filter"></i> Aplicar filtro
                </button>
            </div>

            <!-- Filtro de Categor√≠as -->
            <div class="filter-group">
                <label data-i18n="filter_cats">Categor√≠as</label>
                <div class="custom-dropdown" id="drop-category">
                    <div class="dropdown-header" onclick="toggleDropdown('list-category')">
                        <span id="label-category">----</span>
                        <i class="fa-solid fa-chevron-down"></i>
                    </div>
                    <div id="list-category" class="dropdown-content">
                        <div style="padding: 10px 10px 5px 10px;">
                            <input type="text" id="cat-search-input" class="dropdown-search" placeholder="Buscar..." autocomplete="off">
                        </div>
                        <div class="dropdown-controls" style="padding: 0 10px 10px 10px; display: flex; gap: 5px;">
                            <button class="btn-mini" onclick="toggleGroup('items-category', true, event)" title="Todos"><i class="fa-solid fa-check-double"></i></button>
                            <button class="btn-mini" onclick="toggleGroup('items-category', false, event)" title="Ninguno"><i class="fa-solid fa-minus"></i></button>
                            <button class="btn-mini" onclick="clearCategorySearch(event)" title="Limpiar" style="margin-left: auto;"><i class="fa-solid fa-broom"></i></button>
                        </div>
                        <div class="dropdown-items" id="items-category" style="max-height: 250px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>

            <!-- Contenedor din√°mico para Filtros Extra (Multiselect) -->
            <div id="dynamic-filters-container"></div>

            <div style="margin-top: 20px;">
                <button class="btn-ai-infographic" onclick="generateSmartInfographic()">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> 
                    <span data-i18n="btn_ai_infographic">S√çNTESIS</span>
                </button>
            </div>

            <div class="sidebar-footer">
                <img src="./ImagenCoorporativa/zzenkiu.png" alt="Zzenkiu" class="sidebar-logo">
            </div>
        </aside>

        <main class="main-content">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon"><i class="fa-solid fa-folder-open"></i></div>
                    <div class="kpi-data"><h3 data-i18n="kpi_expedientes">Total</h3><span id="kpi-count">0</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #2dce89;"><i class="fa-solid fa-location-crosshairs"></i></div>
                     <div class="kpi-data"><h3 data-i18n="kpi_zona">Zona</h3><span id="kpi-location">----</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #fb6340;"><i class="fa-solid fa-calendar-check"></i></div>
                    <div class="kpi-data"><h3 data-i18n="kpi_titulo">T√çTULO</h3><span id="card-text-filename">SIN ARCHIVO</span></div>
                </div>
            </div>

            <div class="charts-grid-top">
                <div class="chart-container" id="container-timeline">
                    <div class="chart-header">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button class="btn-mini" onclick="downloadComponent('container-timeline')"><i class="fa-solid fa-download"></i></button>
                            <h4 data-i18n="chart_timeline">Evoluci√≥n</h4>
                        </div>
                        <div class="header-actions">
                            <select id="select-temporal-view" class="btn-mini" onchange="changeTemporalView(this.value)">
                                <option value="year" data-i18n="view_years">A√±os</option>
                                <option value="month" selected data-i18n="view_months">Meses</option>
                                <option value="quarter" data-i18n="view_quarters">Trimestral</option>
                                <option value="day" data-i18n="view_days">D√≠as Semanal</option>
                                <option value="daily" data-i18n="view_daily">Diario</option>
                            </select>
                            <button class="btn-mini" onclick="generateTimelineNarrative()"><i class="fa-solid fa-list-ul"></i></button>
                            <button class="btn-mini" id="btn-toggle-chart-type" onclick="toggleTimelineType()"><i class="fa-solid fa-chart-line"></i></button>
                            <button class="btn-mini" onclick="toggleTimelineView()"><i class="fa-solid fa-table"></i></button>
                            <button class="btn-maximize" onclick="toggleFullscreen('container-timeline')"><i class="fa-solid fa-maximize"></i></button>
                        </div>
                    </div>
                    <div class="canvas-wrapper">
                        <canvas id="chart-timeline"></canvas>
                        <div id="table-timeline-view" class="table-view" style="display: none;"></div>
                    </div>

                    <!-- BARRA CLIMA ‚Äî solo visible en vista Diario -->
                    <div id="meteo-bar" style="display:none; align-items:center; gap:8px; padding:8px 12px; background:linear-gradient(135deg,rgba(255,107,53,0.07),rgba(78,205,196,0.07)); border-top:1px solid rgba(255,107,53,0.18); border-radius:0 0 12px 12px; flex-wrap:wrap;">
                        <i class="fa-solid fa-cloud-sun" style="color:#ff6b35; font-size:1rem;"></i>
                        <span data-i18n="clima_title" style="font-size:0.75rem; font-weight:700; color:#525f7f; text-transform:uppercase; letter-spacing:.5px;">METEOROLOG√çA</span>

                        <button id="btn-meteo-toggle" onclick="toggleMeteo()"
                            style="padding:4px 12px; border:1.5px solid #ff6b35; border-radius:20px; background:transparent; color:#ff6b35; font-size:0.75rem; font-weight:700; cursor:pointer; transition:all .2s; white-space:nowrap;">
                            <i class="fa-solid fa-cloud-sun"></i> <span data-i18n="clima_activate">Activar Clima</span>
                        </button>

                        <select id="meteo-var-select" onchange="onMeteoVarChange()"
                            style="padding:4px 8px; border:1px solid #e2e8f0; border-radius:8px; font-size:0.75rem; color:#525f7f; background:white; cursor:pointer;">
                            <option value="temp"   data-i18n="clima_var_temp">üå° Temperatura</option>
                            <option value="precip" data-i18n="clima_var_precip">üåß Precipitaci√≥n</option>
                            <option value="wind"   data-i18n="clima_var_wind">üí® Viento</option>
                            <option value="snow"   data-i18n="clima_var_snow">‚ùÑ Nieve</option>
                            <option value="all"    data-i18n="clima_var_all">üå§ Todas</option>
                        </select>

                        <select id="meteo-mode-select" onchange="onMeteoModeChange()"
                            style="padding:4px 8px; border:1px solid #e2e8f0; border-radius:8px; font-size:0.75rem; color:#525f7f; background:white; cursor:pointer;">
                            <option value="overlay" data-i18n="clima_mode_overlay">Superpuesto</option>
                            <option value="panel"   data-i18n="clima_mode_panel">Panel separado</option>
                        </select>

                        <!-- Buscador municipio + coordenadas ocultas -->
                        <div style="display:flex; align-items:center; gap:4px; margin-left:auto; position:relative;">
                            <i class="fa-solid fa-location-dot" style="color:#8898aa; font-size:0.75rem;"></i>
                            <div style="position:relative;">
                                <input id="meteo-municipio" type="text" placeholder="Municipio, Provincia"
                                    autocomplete="off"
                                    oninput="onMeteoMunicipioInput(this.value)"
                                    data-i18n-placeholder="clima_municipio_placeholder"
                                    style="width:160px; padding:3px 8px; border:1px solid #e2e8f0; border-radius:6px; font-size:0.72rem; color:#525f7f; background:white;">
                                <div id="meteo-municipio-results"
                                    style="display:none; position:absolute; top:100%; left:0; width:220px; background:white;
                                           border:1px solid #e2e8f0; border-radius:8px; box-shadow:0 4px 16px rgba(0,0,0,0.12);
                                           z-index:9999; max-height:180px; overflow-y:auto;">
                                </div>
                            </div>
                            <!-- Coords ocultas ‚Äî usadas internamente por FncClima -->
                            <input id="meteo-lat" type="hidden">
                            <input id="meteo-lon" type="hidden">
                            <button onclick="onMeteoReload()"
                                data-i18n-title="clima_reload_tip"
                                style="padding:3px 7px; border:1px solid #e2e8f0; border-radius:6px; background:white; color:#525f7f; font-size:0.72rem; cursor:pointer;">
                                <i class="fa-solid fa-rotate-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="chart-container" id="container-category">
                    <div class="chart-header">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button class="btn-mini" onclick="downloadComponent('container-category')"><i class="fa-solid fa-download"></i></button>
                            <h4 data-i18n="chart_top">Top Tipos</h4>
                        </div>
                        <div class="header-actions">
                            <button class="btn-mini" onclick="toggleCategoryView()"><i class="fa-solid fa-table"></i></button>
                            <button class="btn-maximize" onclick="toggleFullscreen('container-category')"><i class="fa-solid fa-maximize"></i></button>
                        </div>
                    </div>
                    <div class="canvas-wrapper">
                        <canvas id="chart-category"></canvas>
                        <div id="table-category-view" class="table-view" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- PANEL METEOROLOG√çA SEPARADO ‚Äî sincronizado con vista Diario -->
            <div id="container-meteo" class="chart-container" style="display:none; margin-bottom:20px;">
                <div class="chart-header">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <i class="fa-solid fa-cloud-sun" style="color:#ff6b35;"></i>
                        <h4 style="margin:0;">Meteorolog√≠a Hist√≥rica</h4>
                        <span id="meteo-panel-location" style="font-size:0.72rem; color:#8898aa; font-weight:400;"></span>
                    </div>
                    <div class="header-actions">
                        <span style="font-size:0.7rem; color:#8898aa;">Open-Meteo Historical API</span>
                    </div>
                </div>
                <div class="canvas-wrapper" style="height:200px;">
                    <canvas id="chart-meteo"></canvas>
                </div>
            </div>

            <div class="bottom-grid">
                <div class="chart-container" id="container-hours">
                    <div class="chart-header">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button class="btn-mini" onclick="downloadComponent('container-hours')"><i class="fa-solid fa-download"></i></button>
                            <h4 data-i18n="chart_hours">Horas</h4>
                        </div>
                        <div class="header-actions">
                            <button class="btn-mini" onclick="toggleHoursView()"><i class="fa-solid fa-table"></i></button>
                            <button class="btn-maximize" onclick="toggleFullscreen('container-hours')"><i class="fa-solid fa-maximize"></i></button>
                        </div>
                    </div>
                    <div class="canvas-wrapper">
                        <canvas id="chart-hours"></canvas>
                        <div id="table-hours-view" class="table-view" style="display: none;"></div>
                    </div>
                </div>
                
<!-- VISTA DE MAPA Y GESTOR DE CAPAS RECONSTRUIDO -->
<div class="map-container-wrapper" id="container-map">
    <div class="chart-header">
        <div style="display: flex; align-items: center; gap: 8px;">
            <button class="btn-mini" onclick="downloadComponent('container-map')" title="Descargar Imagen">
                <i class="fa-solid fa-download"></i>
            </button>
            <h4 data-i18n="chart_map">Mapa</h4>
        </div>
        
        <div class="header-actions">
            <!-- 1. Bot√≥n de Calles -->
            <button class="btn-mini" id="btn-toggle-streets" onclick="toggleStreetsView()" title="Ver Listado de Calles">
                <i class="fa-solid fa-list-ol"></i>
            </button>

            <!-- 2. GESTOR DE CAPAS (Este bloque es el que falla si no est√° exacto) -->
            <div class="layer-manager-container" style="position: relative;">
                <button class="btn-mini" id="btn-layers-menu" onclick="toggleLayerMenu()" title="Gestor de Capas">
                    <i class="fa-solid fa-layer-group"></i>
                </button>
                
                <div id="layers-dropdown" class="layer-dropdown-content">
                    <div class="layer-header">
                        <span data-i18n="map_layers_title">Mis Capas</span>
                        <button id="btn-add-layer-icon" class="btn-add-layer" onclick="document.getElementById('input-geojson').click()" title="Subir GeoJSON">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>

                    <!-- Filtro Espacial -->
                    <div style="padding: 8px 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 8px; font-size: 0.75rem;">
                        <label class="switch">
                            <input type="checkbox" id="chk-spatial-filter" onchange="triggerUpdateWithLoader()">
                            <span class="slider round"></span>
                        </label>
                        <span data-i18n="map_filter_zone">Filtrar por zona</span>
                    </div>

                    <!-- BUSCADOR DE CAPAS (ID CR√çTICO: layer-search) -->
                    <div style="padding: 10px; border-bottom: 1px solid #eee;">
                        <input type="text" id="layer-search" class="dropdown-search" placeholder="Buscar zona..." oninput="searchAndFlyToLayer(this.value)" style="width: 100%; display: block;">
                    </div>

                    <!-- LISTA DE CAPAS (ID CR√çTICO: layers-list) -->
                    <div id="layers-list" class="layer-list-body">
                        <p class="empty-layers-msg" data-i18n="map_no_layers">Sin capas cargadas</p>
                    </div>
                </div>
            </div>

            <!-- 3. Herramientas de Mapa -->
            <input type="file" id="input-geojson" accept=".geojson, .json" style="display: none;" onchange="handleGeojsonUpload(this)">
            
            <button class="btn-mini" id="btn-heatmap" onclick="toggleHeatmap(this)" title="Mapa de Calor">
                <i class="fa-solid fa-fire"></i>
            </button>

            <button class="btn-mini" id="btn-smart-focus" onclick="focusIntelligentHotspot()" title="Zona Cr√≠tica">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
            </button>

            <button class="btn-mini" onclick="toggleSatelite(this)" title="Satelite">
                <i class="fa-solid fa-earth-americas"></i>
            </button>

            <button class="btn-mini" id="btn-3d" onclick="toggle3D()" data-i18n-title="map_btn_3d" title="Vista 3D">
                <i class="fa-solid fa-cube"></i>
            </button>
            
            <button class="btn-maximize" onclick="toggleFullscreen('container-map')">
                <i class="fa-solid fa-expand"></i>
            </button>
        </div>
    </div>

    <div class="canvas-wrapper">
        <div id="main-map"></div>
        <!-- Toast para mensajes del mapa (Cerca de, Hotspots, etc) -->
        <div id="map-toast" class="map-toast"></div>
        <!-- Tabla de calles oculta -->
        <div id="table-streets-view" class="table-view" style="display: none;"></div>
    </div>
</div>
            </div>
        </main>
    </section>
<div id="layers-dropdown" class="layer-dropdown-content">
    <div class="layer-header">
        <span data-i18n="map_layers_title">Mis Capas</span>
        <button class="btn-add-layer" onclick="document.getElementById('input-geojson').click()"><i class="fa-solid fa-plus"></i></button>
    </div>
    
    <!-- A√ëADIR ESTE BLOQUE: Es el buscador que pide el JS -->
    <div style="padding: 10px; border-bottom: 1px solid #eee;">
        <input type="text" id="layer-search" class="dropdown-search" placeholder="Buscar zona..." style="display: none; width: 100%;">
    </div>

    <div style="padding: 5px 10px; border-bottom: 1px solid #eee;">
        <label class="switch">
            <input type="checkbox" id="chk-spatial-filter" onchange="triggerUpdateWithLoader()">
            <span class="slider round"></span>
        </label>
        <small data-i18n="map_filter_zone">Filtrar por zona</small>
    </div>
    <div id="layers-list" class="layer-list-body"></div>
</div>
    <!-- MODALES Y NOTIFICACIONES -->
    <div id="loading-overlay" class="loading-overlay"><div class="spinner-box"><div class="spinner"></div><p data-i18n="loading_msg">Procesando...</p></div></div>

    <div id="toast-notification" class="toast-notification"><i class="fa-solid fa-triangle-exclamation"></i><span id="toast-message"></span></div>

    <!-- MODAL ARCHIVOS GRANDES -->
    <!-- MODAL PARA ARCHIVOS GRANDES (>1MB) - DISE√ëO RESTAURADO -->
    <div id="large-file-modal" class="pdf-modal-overlay" style="z-index: 9999;">
        <div class="pdf-modal-content" style="max-width: 450px; height: auto; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
            
            <!-- Cabecera Azul -->
            <div class="pdf-header" style="background: var(--accent-blue); color: white; padding: 20px; border-bottom: none;">
                <h3 style="margin: 0; font-size: 1.1rem;">
                    <i class="fa-solid fa-triangle-exclamation"></i> 
                    <span data-i18n="modal_large_title">Archivo Grande Detectado</span>
                </h3>
            </div>

            <div class="pdf-body" style="padding: 30px; text-align: center; background: #fff;">
                <p style="color: #525f7f; font-size: 0.95rem; line-height: 1.5; margin-bottom: 25px;" data-i18n="modal_large_desc">
                    El archivo es superior a 1 MB. Para optimizar la velocidad, selecciona a partir de qu√© a√±o quieres cargar los datos.
                </p>
                
                <div style="margin-bottom: 30px; text-align: left;">
                    <label style="font-size: 0.75rem; font-weight: 800; color: var(--primary-dark); text-transform: uppercase; display: block; margin-bottom: 8px;" data-i18n="modal_large_label">
                        CARGAR DESDE EL A√ëO:
                    </label>
                    <select id="large-file-year-select" class="styled-select" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 10px; font-weight: 700; color: var(--accent-blue); cursor: pointer;">
                        <!-- Se llena v√≠a JS -->
                    </select>
                </div>

                <!-- Botones con dise√±o de la aplicaci√≥n -->
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button onclick="cancelLargeFileLoad()" class="btn-mini" style="padding: 12px 24px; border-color: #f5365c; color: #f5365c; font-weight: 800;">
                        CANCELAR
                    </button>
                    <button onclick="confirmLargeFileYear()" class="btn-primary" style="padding: 12px 30px; min-width: 140px;" data-i18n="btn_continue">
                        CONTINUAR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL NARRATIVA -->
    <div id="narrative-modal" class="pdf-modal-overlay">
        <div class="pdf-modal-content" style="max-width: 600px; height: 80vh;">
            <div class="pdf-header" style="background: #5e72e4; color: white;">
                <h3><i class="fa-solid fa-list-ul"></i> <span data-i18n="narrative_title">An√°lisis Narrativo</span></h3>
                <button onclick="document.getElementById('narrative-modal').classList.remove('active')" class="btn-close-pdf" style="color:white;"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="pdf-body" style="padding: 20px; overflow-y: auto; background: #f8f9fe;">
                <h4 data-i18n="narrative_summary" style="font-size: 0.8rem; font-weight: 800; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 15px;"></h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 25px;">
                    <div style="background: white; padding: 10px; border-radius: 8px; text-align: center; border-top: 3px solid #2dce89;">
                        <small data-i18n="narrative_max"></small><div id="narrative-max-val" style="font-size: 1.1rem; font-weight: 800;"></div><small id="narrative-max-lbl" style="color: #2dce89; font-weight: 600;"></small>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 8px; text-align: center; border-top: 3px solid #f5365c;">
                        <small data-i18n="narrative_min"></small><div id="narrative-min-val" style="font-size: 1.1rem; font-weight: 800;"></div><small id="narrative-min-lbl" style="color: #f5365c; font-weight: 600;"></small>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 8px; text-align: center; border-top: 3px solid #11cdef;">
                        <small data-i18n="narrative_avg"></small><div id="narrative-avg-val" style="font-size: 1.1rem; font-weight: 800;"></div><small data-i18n="narrative_records" style="color: #11cdef;"></small>
                    </div>
                </div>
                <h4 data-i18n="narrative_chronology" style="font-size: 0.8rem; font-weight: 800; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 15px;"></h4>
                <div id="narrative-list-container" style="background: white; border-radius: 8px; padding: 10px;"></div>
            </div>
        </div>
    </div>

    <!-- MODAL REGISTROS RECHAZADOS (fechas inv√°lidas) -->
    <div id="rejected-modal" class="pdf-modal-overlay">
        <div class="pdf-modal-content" style="max-width: 480px; height: auto; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
            <div class="pdf-header" style="background: #f5365c;">
                <h3 style="color:white;"><i class="fa-solid fa-triangle-exclamation"></i> Avisos de procesamiento</h3>
                <button onclick="closeRejectedModal()" class="btn-close-pdf" style="color:white;"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="pdf-body" style="padding: 20px; background: white; max-height: 60vh; overflow-y: auto;">
                <p style="color:#525f7f; font-size:0.9rem; margin-bottom:15px;">Los registros sin fecha o categor√≠a han sido procesados con valores por defecto:</p>
                <div id="rejected-list" style="font-size:0.85rem; color:#32325d; display:flex; flex-direction:column; gap:6px;"></div>
            </div>
            <div style="padding: 15px 20px; background: #f8f9fa; border-top: 1px solid #e9ecef; text-align:right;">
                <button onclick="closeRejectedModal()" style="padding: 8px 20px; background:#5e72e4; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer;">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- OTROS MODALES (PDF, Errores, Registros) -->
    <div id="pdf-modal" class="pdf-modal-overlay">
        <div class="pdf-modal-content">
            <div class="pdf-header">
                <h3 id="pdf-modal-title"><i class="fa-solid fa-image"></i></h3>
                <button onclick="closePdfModal()" class="btn-close-pdf"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="pdf-body" style="background: #333; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                <iframe src="" id="pdf-frame" frameborder="0" style="display:none; width:100%; height:100%;"></iframe>
                <img id="img-frame" src="" style="display:none; max-width: 100%; max-height: 100%; object-fit: contain;">
            </div>
        </div>
    </div>
<!-- PLANTILLA OCULTA PARA GENERACI√ìN DE INFOGRAF√çA -->
<div id="ai-infographic-container" class="infographic-canvas" style="position: fixed; left: -9999px;">

    <!-- CABECERA -->
    <div class="info-header">
        <div class="header-text-group">
            <div class="info-tag" data-i18n="info_tag">EUROCOP ANALYTICS ‚Ä¢ S√çNTESIS</div>
            <h1 id="info-title">Informe</h1>
            <p id="info-subtitle" data-i18n="info_subtitle">An√°lisis de datos filtrados</p>
        </div>
        <img src="./ImagenCoorporativa/zzenkiu.png" class="header-logo" alt="Logo">
    </div>

    <!-- GRID PRINCIPAL -->
    <div class="info-grid">

        <!-- FILA 1: S√≠ntesis principal ‚Äî ancho completo con % integrado -->
        <div class="info-card highlight-card">
            <div class="highlight-left">
                <div class="card-icon"><i class="fa-solid fa-bolt"></i> <span data-i18n="info_card_sintesis">S√çNTESIS PRINCIPAL</span></div>
                <h2 id="info-insight-main">...</h2>
            </div>
            <div class="highlight-right">
                <span class="big-pct" id="info-pie-percent">0%</span>
                <span class="big-label" data-i18n="clima_dominancia">dominancia</span>
                <span class="big-cat" id="info-lbl-leader">‚Äî</span>
                <!-- SVG oculto (sigue siendo actualizado por JS para compatibilidad) -->
                <svg width="0" height="0" style="position:absolute">
                    <circle id="svg-pie-progress" cx="60" cy="60" r="54" fill="none" stroke="#5e72e4" stroke-width="12" stroke-linecap="round" stroke-dasharray="339.29" stroke-dashoffset="339.29" transform="rotate(-90 60 60)" />
                </svg>
                <span id="info-pie-subtext" style="font-size:0.62rem; color:rgba(255,255,255,0.35); margin-top:2px;">0 vs 0</span>
                <span id="info-lbl-resto" style="display:none"></span>
            </div>
        </div>

        <!-- FILA 2: Estad√≠sticas | Ubicaciones + Tendencia | Top 3 -->
        <div class="info-card stats-card">
            <h3 data-i18n="info_lbl_stats">KPIs</h3>
            <div class="stat-item">
                <span class="stat-label" data-i18n="info_lbl_total">TOTAL REGISTROS</span>
                <span class="stat-value" id="info-stat-total">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label" data-i18n="info_lbl_peak">PICO DE ACTIVIDAD</span>
                <span class="stat-value" id="info-stat-peak">--:--</span>
            </div>
            <div class="stat-item">
                <span class="stat-label" data-i18n="info_lbl_day">D√çA M√ÅS ACTIVO</span>
                <span class="stat-value" style="font-size:1.2rem;" id="info-stat-day">---</span>
            </div>
        </div>

        <div class="info-card tendency-card">
            <h3 data-i18n="info_lbl_streets">UBICACIONES CR√çTICAS</h3>
            <ul id="info-street-list" class="info-list"></ul>
            <h3 data-i18n="info_lbl_trend" style="margin-top:14px; padding-top:12px; border-top:1px solid #f3f4f6;">TENDENCIA</h3>
            <p id="info-text-trend" class="info-text-body">...</p>
        </div>

        <div class="info-card dark-card">
            <h3 data-i18n="info_lbl_top3">TOP 3 CATEGOR√çAS</h3>
            <ul id="info-top-list" class="info-list"></ul>
        </div>

        <!-- FILA 3: Meteorolog√≠a ‚Äî solo visible en vista Diario con clima activo -->
        <div id="info-meteo-card" class="info-card info-meteo-card" style="display:none;">
            <div class="card-icon"><i class="fa-solid fa-cloud-sun-rain"></i> <span>CORRELACI√ìN METEOROL√ìGICA</span></div>
            <div id="info-meteo-body" class="info-meteo-body"></div>
        </div>

    </div>

    <!-- FOOTER -->
    <div class="info-footer">
        <span data-i18n="info_lbl_footer">Generado por Eurocop Analytics AI</span>
        <span id="info-date">--/--/----</span>
    </div>
</div>
    <!-- CARGA DE SCRIPTS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
    <script src="languages.js"></script>
    <script>
        var v = EUROCOP_VERSION;
        var modules = [
            'FncFunciones/FncGlobales.js',
            'FncFunciones/FncUtilidades.js',
            'FncFunciones/FncCargaArchivo.js',
            'FncFunciones/FncMapeo.js',
            'FncFunciones/FncGeolocalizacion.js',
            'FncFunciones/FncGraficos.js',
            'FncFunciones/FncMapa.js',
            'FncFunciones/FncTablas.js',
            'FncFunciones/FncFiltros.js',
            'FncFunciones/FncMultiselect.js',
            'FncFunciones/FncClima.js',
            'FncFunciones/FncProcesamiento.js',
            'FncFunciones/FncIdioma.js',
            'FncFunciones/FncInfografia.js',
            'FncFunciones/FncConvertirPdf.js',
            'script.js'
        ];
        modules.forEach(function(m) { document.write('<script src="' + m + '?v=' + v + '"><\/script>'); });
    </script>
</body>
</html>